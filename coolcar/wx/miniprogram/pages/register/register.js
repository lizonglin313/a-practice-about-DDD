"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const profile_1 = require("../../service/profile");
const rental_pb_1 = require("../../service/proto_gen/rental/rental_pb");
const format_1 = require("../../utils/format");
function formatDate(millis) {
    const dt = new Date(millis);
    const y = dt.getFullYear();
    const m = dt.getMonth() + 1;
    const d = dt.getDate();
    return `${format_1.padString(y)}-${format_1.padString(m)}-${format_1.padString(d)}`;
}
Page({
    redirectURL: '',
    profileRefresher: 0,
    data: {
        licNo: '',
        name: '',
        genderIndex: 0,
        genders: ['未知', '男', '女'],
        birthDate: '1990-01-01',
        licImgURL: '',
        state: rental_pb_1.rental.v1.IdentityStatus[rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED]
    },
    renderProfile(p) {
        var _a, _b, _c, _d;
        this.setData({
            licNo: ((_a = p.identity) === null || _a === void 0 ? void 0 : _a.licNumber) || '',
            name: ((_b = p.identity) === null || _b === void 0 ? void 0 : _b.name) || '',
            genderIndex: ((_c = p.identity) === null || _c === void 0 ? void 0 : _c.gender) || 0,
            birthDate: formatDate(((_d = p.identity) === null || _d === void 0 ? void 0 : _d.brithDateMillis) || 0),
            state: rental_pb_1.rental.v1.IdentityStatus[p.identityStatus || 0]
        });
    },
    onLoad(opt) {
        const o = opt;
        if (o.redirect) {
            this.redirectURL = decodeURIComponent(o.redirect);
        }
        profile_1.ProfileService.getProfile().then(p => this.renderProfile(p));
    },
    onUnload() {
        this.clearProfileRefresher();
    },
    onUploadLic() {
        wx.downloadFile({
            url: 'http://coolcar-lzl.oss-cn-beijing.aliyuncs.com/account_9623aef4bf56efac37b44f217?Expires=1648032204&OSSAccessKeyId=LTAI5tLK8Ckc7uPgkxTFh5aB&Signature=TjP%2FZMqn4MQFi8dIKs4%2BR%2BVJ5fI%3D',
            header: { 'Content-Type': 'image/jpeg' },
            success(res) {
                if (res.statusCode === 200) {
                    console.log(123);
                    console.log(res.tempFilePath);
                    console.log(123);
                    wx.setStorageSync('licPicUrl', res.tempFilePath);
                }
            }
        });
        console.log("storage", wx.getStorageSync('licPicUrl'));
        this.setData({
            licImgURL: wx.getStorageSync('licPicUrl'),
        });
        wx.chooseImage({
            success: res => {
                if (res.tempFilePaths.length > 0) {
                    this.setData({
                        licImgURL: res.tempFilePaths[0]
                    });
                    const data = wx.getFileSystemManager().readFileSync(res.tempFilePaths[0]);
                }
            }
        });
    },
    onGenderChange(e) {
        this.setData({
            genderIndex: parseInt(e.detail.value),
        });
    },
    onBirthDateChange(e) {
        this.setData({
            birthDate: e.detail.value,
        });
    },
    onSubmit() {
        profile_1.ProfileService.submintProfile({
            licNumber: this.data.licNo,
            name: this.data.name,
            gender: this.data.genderIndex,
            brithDateMillis: Date.parse(this.data.birthDate)
        }).then(p => {
            this.renderProfile(p);
            this.scheduleProfileRefresher();
        });
    },
    scheduleProfileRefresher() {
        this.profileRefresher = setInterval(() => {
            profile_1.ProfileService.getProfile().then(p => {
                this.renderProfile(p);
                if (p.identityStatus !== rental_pb_1.rental.v1.IdentityStatus.PENDING) {
                    this.clearProfileRefresher();
                }
                if (p.identityStatus === rental_pb_1.rental.v1.IdentityStatus.VERIFIED) {
                    this.onLicVerified();
                }
            });
        }, 1000);
    },
    clearProfileRefresher() {
        if (this.profileRefresher) {
            clearInterval(this.profileRefresher);
            this.profileRefresher = 0;
        }
    },
    onReSubmit() {
        profile_1.ProfileService.clearProfile().then(p => this.renderProfile(p));
    },
    onLicVerified() {
        if (this.redirectURL) {
            wx.redirectTo({
                url: this.redirectURL,
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQUFzRDtBQUN0RCx3RUFBaUU7QUFDakUsK0NBQThEO0FBSTlELFNBQVMsVUFBVSxDQUFDLE1BQWM7SUFDOUIsTUFBTSxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDM0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzFCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDM0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ3RCLE9BQU8sR0FBRyxrQkFBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLGtCQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksa0JBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO0FBQzVELENBQUM7QUFFRCxJQUFJLENBQUM7SUFDRCxXQUFXLEVBQUUsRUFBRTtJQUNmLGdCQUFnQixFQUFFLENBQUM7SUFDbkIsSUFBSSxFQUFFO1FBQ0YsS0FBSyxFQUFFLEVBQUU7UUFDVCxJQUFJLEVBQUUsRUFBRTtRQUNSLFdBQVcsRUFBRSxDQUFDO1FBQ2QsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFDekIsU0FBUyxFQUFFLFlBQVk7UUFDdkIsU0FBUyxFQUFFLEVBQUU7UUFDYixLQUFLLEVBQUUsa0JBQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUM7S0FDeEU7SUFFRCxhQUFhLENBQUMsQ0FBcUI7O1FBQy9CLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDVCxLQUFLLEVBQUUsT0FBQSxDQUFDLENBQUMsUUFBUSwwQ0FBRSxTQUFTLEtBQUksRUFBRTtZQUNs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Q04sd0JBQWMsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbEUsQ0FBQztJQUNELGFBQWE7UUFJVCxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEIsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDVixHQUFHLEVBQUUsSUFBSSxDQUFDLFdBQVc7YUFDeEIsQ0FBQyxDQUFBO1NBQ0w7SUFFTCxDQUFDO0NBQ0osQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvZmlsZVNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9wcm9maWxlXCJcclxuaW1wb3J0IHsgcmVudGFsIH0gZnJvbSBcIi4uLy4uL3NlcnZpY2UvcHJvdG9fZ2VuL3JlbnRhbC9yZW50YWxfcGJcIlxyXG5pbXBvcnQgeyBmb3JtYXREdXJhdGlvbiwgcGFkU3RyaW5nIH0gZnJvbSBcIi4uLy4uL3V0aWxzL2Zvcm1hdFwiXHJcbmltcG9ydCB7IHJvdXRpbmcgfSBmcm9tIFwiLi4vLi4vdXRpbHMvcm91dGluZ1wiXHJcblxyXG5cclxuZnVuY3Rpb24gZm9ybWF0RGF0ZShtaWxsaXM6IG51bWJlcikge1xyXG4gICAgY29uc3QgZHQgPSBuZXcgRGF0ZShtaWxsaXMpXHJcbiAgICBjb25zdCB5ID0gZHQuZ2V0RnVsbFllYXIoKVxyXG4gICAgY29uc3QgbSA9IGR0LmdldE1vbnRoKCkgKyAxXHJcbiAgICBjb25zdCBkID0gZHQuZ2V0RGF0ZSgpXHJcbiAgICByZXR1cm4gYCR7cGFkU3RyaW5nKHkpfS0ke3BhZFN0cmluZyhtKX0tJHtwYWRTdHJpbmcoZCl9YFxyXG59XHJcblxyXG5QYWdlKHtcclxuICAgIHJlZGlyZWN0VVJMOiAnJyxcclxuICAgIHByb2ZpbGVSZWZyZXNoZXI6IDAsXHJcbiAgICBkYXRhOiB7XHJcbiAgICAgICAgbGljTm86ICcnLFxyXG4gICAgICAgIG5hbWU6ICcnLFxyXG4gICAgICAgIGdlbmRlckluZGV4OiAwLFxyXG4gICAgICAgIGdlbmRlcnM6IFsn5pyq55+lJywgJ+eUtycsICflpbMnXSxcclxuICAgICAgICBiaXJ0aERhdGU6ICcxOTkwLTAxLTAxJyxcclxuICAgICAgICBsaWNJbWdVUkw6ICcnLFxyXG4gICAgICAgIHN0YXRlOiByZW50YWwudjEuSWRlbnRpdHlTdGF0dXNbcmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlVOU1VCTUlUVEVEXVxyXG4gICAgfSxcclxuXHJcbiAgICByZW5kZXJQcm9maWxlKHA6IHJlbnRhbC52MS5JUHJvZmlsZSkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGxpY05vOiBwLmlkZW50aXR5Py5saWNOdW1iZXIgfHwgJycsXHJcbiAgICAgICAgICAgIG5hbWU6IHAuaWRlbnRpdHk/Lm5hbWUgfHwgJycsXHJcbiAgICAgICAgICAgIGdlbmRlckluZGV4OiBwLmlkZW50aXR5Py5nZW5kZXIgfHwgMCxcclxuICAgICAgICAgICAgYmlydGhEYXRlOiBmb3JtYXREYXRlKHAuaWRlbnRpdHk/LmJyaXRoRGF0ZU1pbGxpcyB8fCAwKSxcclxuICAgICAgICAgICAgc3RhdGU6IHJlbnRhbC52MS5JZGVudGl0eVN0YXR1c1twLmlkZW50aXR5U3RhdHVzIHx8IDBdXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgb25Mb2FkKG9wdDogUmVjb3JkPCdyZWRpcmVjdCcsIHN0cmluZz4pIHtcclxuICAgICAgICBjb25zdCBvOiByb3V0aW5nLlJlZ2lzdGVyT3B0cyA9IG9wdFxyXG4gICAgICAgIGlmIChvLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVkaXJlY3RVUkwgPSBkZWNvZGVVUklDb21wb25lbnQoby5yZWRpcmVjdClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKS50aGVuKHAgPT4gdGhpcy5yZW5kZXJQcm9maWxlKHApKVxyXG4gICAgfSxcclxuXHJcbiAgICBvblVubG9hZCgpIHtcclxuICAgICAgICB0aGlzLmNsZWFyUHJvZmlsZVJlZnJlc2hlcigpXHJcbiAgICB9LFxyXG5cclxuICAgIG9uVXBsb2FkTGljKCkge1xyXG4gICAgICAgIC8vIOeUqOS6jua1i+ivleiOt+WPluWbvueJh1VSTFxyXG4gICAgICAgIC8vbGV0IGxpY191cmxfdGVzdDogc3RyaW5nID0gJydcclxuICAgICAgICAgLy8g5rWL6K+V6I635Y+WXHJcbiAgICAgICAgIHd4LmRvd25sb2FkRmlsZSh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly9jb29sY2FyLWx6bC5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vYWNjb3VudF85NjIzYWVmNGJmNTZlZmFjMzdiNDRmMjE3P0V4cGlyZXM9MTY0ODAzMjIwNCZPU1NBY2Nlc3NLZXlJZD1MVEFJNXRMSzhDa2M3dVBna3hURmg1YUImU2lnbmF0dXJlPVRqUCUyRlpNcW40TVFGaThkSUtzNCUyQlIlMkJWSjVmSSUzRCcsXHJcbiAgICAgICAgICAgIGhlYWRlcjogeyAnQ29udGVudC1UeXBlJzogJ2ltYWdlL2pwZWcnIH0sXHJcbiAgICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDlj6ropoHmnI3liqHlmajmnInlk43lupTmlbDmja7vvIzlsLHkvJrmiorlk43lupTlhoXlrrnlhpnlhaXmlofku7blubbov5vlhaUgc3VjY2VzcyDlm57osIPvvIzkuJrliqHpnIDopoHoh6rooYzliKTmlq3mmK/lkKbkuIvovb3liLDkuobmg7PopoHnmoTlhoXlrrlcclxuICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coMTIzKVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcy50ZW1wRmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coMTIzKVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOebtOaOpSBzZXQg5Yiw5Zu+54mH6Lev5b6EXHJcbiAgICAgICAgICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoJ2xpY1BpY1VybCcsIHJlcy50ZW1wRmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICBcclxuICAgICAgICBjb25zb2xlLmxvZyhcInN0b3JhZ2VcIiwgd3guZ2V0U3RvcmFnZVN5bmMoJ2xpY1BpY1VybCcpKVxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGxpY0ltZ1VSTDogd3guZ2V0U3RvcmFnZVN5bmMoJ2xpY1BpY1VybCcpLFxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIC8vIC0tLS1cclxuICAgICAgICB3eC5jaG9vc2VJbWFnZSh7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLnRlbXBGaWxlUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpY0ltZ1VSTDogcmVzLnRlbXBGaWxlUGF0aHNbMF1cclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IHVwbG9hZCBsaWNcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKS5yZWFkRmlsZVN5bmMocmVzLnRlbXBGaWxlUGF0aHNbMF0pXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOa1i+ivleS4iuS8oFxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHd4LnJlcXVlc3Qoe1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICB1cmw6ICdodHRwOi8vY29vbGNhci1semwub3NzLWNuLWJlaWppbmcuYWxpeXVuY3MuY29tL2FjY291bnRfOTYyM2FlZjRiZjU2ZWZhYzM3YjQ0ZjIxNz9FeHBpcmVzPTE2NDgwMzA1MTUmT1NTQWNjZXNzS2V5SWQ9TFRBSTV0TEs4Q2tjN3VQZ2t4VEZoNWFCJlNpZ25hdHVyZT0lMkZCOVhmd2lUb0FlcU8wd3BUbkJPb3JtQnA3USUzRCcsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGhlYWRlcjogeydDb250ZW50LVR5cGUnOiAnaW1hZ2UvanBlZyd9LFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICBzdWNjZXNzOiBjb25zb2xlLmxvZyxcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgZmFpbDogY29uc29sZS5lcnJvcixcclxuICAgICAgICAgICAgICAgICAgICAvLyB9KVxyXG5cclxuICAgICAgICAgICAgICAgICAgIFxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5YGH6K6+562J5LiA56eS5omN5ou/5Yiw6Kej5p6Q5a6MXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICBsaWNObzogJzMyNDM2MzMyNTQnLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgbmFtZTogJ+W8oOS4iScsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICBnZW5kZXJJbmRleDogMSxcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIGJpcnRoRGF0ZTogJzE5OTktMTItMjMnLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIH0sIDEwMDApXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgb25HZW5kZXJDaGFuZ2UoZTogYW55KSB7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgZ2VuZGVySW5kZXg6IHBhcnNlSW50KGUuZGV0YWlsLnZhbHVlKSxcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkJpcnRoRGF0ZUNoYW5nZShlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBiaXJ0aERhdGU6IGUuZGV0YWlsLnZhbHVlLFxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uU3VibWl0KCkge1xyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLnN1Ym1pbnRQcm9maWxlKHtcclxuICAgICAgICAgICAgbGljTnVtYmVyOiB0aGlzLmRhdGEubGljTm8sXHJcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuZGF0YS5uYW1lLFxyXG4gICAgICAgICAgICBnZW5kZXI6IHRoaXMuZGF0YS5nZW5kZXJJbmRleCxcclxuICAgICAgICAgICAgYnJpdGhEYXRlTWlsbGlzOiBEYXRlLnBhcnNlKHRoaXMuZGF0YS5iaXJ0aERhdGUpXHJcbiAgICAgICAgfSkudGhlbihwID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJQcm9maWxlKHApXHJcbiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVQcm9maWxlUmVmcmVzaGVyKClcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBzY2hlZHVsZVByb2ZpbGVSZWZyZXNoZXIoKSB7XHJcbiAgICAgICAgLy8g5q+P56eS6L+b6KGM6L2u6K+iXHJcbiAgICAgICAgdGhpcy5wcm9maWxlUmVmcmVzaGVyID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICBQcm9maWxlU2VydmljZS5nZXRQcm9maWxlKCkudGhlbihwID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyUHJvZmlsZShwKVxyXG4gICAgICAgICAgICAgICAgaWYgKHAuaWRlbnRpdHlTdGF0dXMgIT09IHJlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5QRU5ESU5HKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclByb2ZpbGVSZWZyZXNoZXIoKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHAuaWRlbnRpdHlTdGF0dXMgPT09IHJlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5WRVJJRklFRCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25MaWNWZXJpZmllZCgpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSwgMTAwMClcclxuICAgIH0sXHJcblxyXG4gICAgY2xlYXJQcm9maWxlUmVmcmVzaGVyKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnByb2ZpbGVSZWZyZXNoZXIpIHtcclxuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnByb2ZpbGVSZWZyZXNoZXIpXHJcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZVJlZnJlc2hlciA9IDBcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIG9uUmVTdWJtaXQoKSB7XHJcbiAgICAgICAgUHJvZmlsZVNlcnZpY2UuY2xlYXJQcm9maWxlKCkudGhlbihwID0+IHRoaXMucmVuZGVyUHJvZmlsZShwKSlcclxuICAgIH0sXHJcbiAgICBvbkxpY1ZlcmlmaWVkKCkge1xyXG4gICAgICAgIC8vIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgLy8gICAgIHN0YXRlOiAnVkVSSUZJRUQnLFxyXG4gICAgICAgIC8vIH0pXHJcbiAgICAgICAgaWYgKHRoaXMucmVkaXJlY3RVUkwpIHtcclxuICAgICAgICAgICAgd3gucmVkaXJlY3RUbyh7XHJcbiAgICAgICAgICAgICAgICB1cmw6IHRoaXMucmVkaXJlY3RVUkwsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxufSkiXX0=