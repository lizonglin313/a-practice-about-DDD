"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const profile_1 = require("../../service/profile");
const rental_pb_1 = require("../../service/proto_gen/rental/rental_pb");
const format_1 = require("../../utils/format");
function formatDate(millis) {
    const dt = new Date(millis);
    const y = dt.getFullYear();
    const m = dt.getMonth() + 1;
    const d = dt.getDate();
    return `${format_1.padString(y)}-${format_1.padString(m)}-${format_1.padString(d)}`;
}
Page({
    redirectURL: '',
    profileRefresher: 0,
    data: {
        licNo: '',
        name: '',
        genderIndex: 0,
        genders: ['未知', '男', '女'],
        birthDate: '1990-01-01',
        licImgURL: '',
        state: rental_pb_1.rental.v1.IdentityStatus[rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED]
    },
    renderProfile(p) {
        var _a, _b, _c, _d;
        this.setData({
            licNo: ((_a = p.identity) === null || _a === void 0 ? void 0 : _a.licNumber) || '',
            name: ((_b = p.identity) === null || _b === void 0 ? void 0 : _b.name) || '',
            genderIndex: ((_c = p.identity) === null || _c === void 0 ? void 0 : _c.gender) || 0,
            birthDate: formatDate(((_d = p.identity) === null || _d === void 0 ? void 0 : _d.brithDateMillis) || 0),
            state: rental_pb_1.rental.v1.IdentityStatus[p.identityStatus || 0]
        });
    },
    onLoad(opt) {
        const o = opt;
        if (o.redirect) {
            this.redirectURL = decodeURIComponent(o.redirect);
        }
        profile_1.ProfileService.getProfile().then(p => this.renderProfile(p));
    },
    onUnload() {
        this.clearProfileRefresher();
    },
    onUploadLic() {
        wx.chooseImage({
            success: res => {
                if (res.tempFilePaths.length > 0) {
                    this.setData({
                        licImgURL: res.tempFilePaths[0]
                    });
                    const data = wx.getFileSystemManager().readFileSync(res.tempFilePaths[0]);
                    wx.request({
                        method: 'PUT',
                        url: 'https://coolcar-1258527714.cos.ap-chengdu.myqcloud.com/account_7/6238aff191d403467ac7896b?q-sign-algorithm=sha1&q-ak=AKIDkJdhX7SXNyJPJyNWQ5UdXBajdHgpjQt7&q-sign-time=1647882225%3B1647883225&q-key-time=1647882225%3B1647883225&q-header-list=content-type%3Bhost&q-url-param-list=&q-signature=e61cdf9a01088cffadc5f1246701c24967c80656',
                        data: data,
                        header: { 'content-type': 'image/jpeg' },
                        success: console.log,
                        fail: console.error,
                    });
                }
            }
        });
    },
    onGenderChange(e) {
        this.setData({
            genderIndex: parseInt(e.detail.value),
        });
    },
    onBirthDateChange(e) {
        this.setData({
            birthDate: e.detail.value,
        });
    },
    onSubmit() {
        profile_1.ProfileService.submintProfile({
            licNumber: this.data.licNo,
            name: this.data.name,
            gender: this.data.genderIndex,
            brithDateMillis: Date.parse(this.data.birthDate)
        }).then(p => {
            this.renderProfile(p);
            this.scheduleProfileRefresher();
        });
    },
    scheduleProfileRefresher() {
        this.profileRefresher = setInterval(() => {
            profile_1.ProfileService.getProfile().then(p => {
                this.renderProfile(p);
                if (p.identityStatus !== rental_pb_1.rental.v1.IdentityStatus.PENDING) {
                    this.clearProfileRefresher();
                }
                if (p.identityStatus === rental_pb_1.rental.v1.IdentityStatus.VERIFIED) {
                    this.onLicVerified();
                }
            });
        }, 1000);
    },
    clearProfileRefresher() {
        if (this.profileRefresher) {
            clearInterval(this.profileRefresher);
            this.profileRefresher = 0;
        }
    },
    onReSubmit() {
        profile_1.ProfileService.clearProfile().then(p => this.renderProfile(p));
    },
    onLicVerified() {
        if (this.redirectURL) {
            wx.redirectTo({
                url: this.redirectURL,
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQUFzRDtBQUN0RCx3RUFBaUU7QUFDakUsK0NBQThEO0FBSTlELFNBQVMsVUFBVSxDQUFDLE1BQWM7SUFDOUIsTUFBTSxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDM0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzFCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDM0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ3RCLE9BQU8sR0FBRyxrQkFBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLGtCQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksa0JBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO0FBQzVELENBQUM7QUFFRCxJQUFJLENBQUM7SUFDRCxXQUFXLEVBQUUsRUFBRTtJQUNmLGdCQUFnQixFQUFFLENBQUM7SUFDbkIsSUFBSSxFQUFFO1FBQ0YsS0FBSyxFQUFFLEVBQUU7UUFDVCxJQUFJLEVBQUUsRUFBRTtRQUNSLFdBQVcsRUFBRSxDQUFDO1FBQ2QsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFDekIsU0FBUyxFQUFFLFlBQVk7UUFDdkIsU0FBUyxFQUFFLEVBQUU7UUFDYixLQUFLLEVBQUUsa0JBQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUM7S0FDeEU7SUFFRCxhQUFhLENBQUMsQ0FBcUI7O1FBQy9CLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDVCxLQUFLLEVBQUUsT0FBQSxDQUFDLENBQUMsUUFBUSwwQ0FBRSxTQUFTLEtBQUksRUFBRTtZQUNs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LGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDckMsd0JBQWMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3JCLElBQUksQ0FBQyxDQUFDLGNBQWMsS0FBSyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFO29CQUN2RCxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQTtpQkFDL0I7Z0JBQ0QsSUFBSSxDQUFDLENBQUMsY0FBYyxLQUFLLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUU7b0JBQ3hELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtpQkFDdkI7WUFDTCxDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUNaLENBQUM7SUFFRCxxQkFBcUI7UUFDakIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDdkIsYUFBYSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1lBQ3BDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUE7U0FDNUI7SUFDTCxDQUFDO0lBRUQsVUFBVTtRQUNOLHdCQUFjLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xFLENBQUM7SUFDRCxhQUFhO1FBSVQsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2xCLEVBQUUsQ0FBQyxVQUFVLENBQUM7Z0JBQ1YsR0FBRyxFQUFFLElBQUksQ0FBQyxXQUFXO2FBQ3hCLENBQUMsQ0FBQTtTQUNMO0lBRUwsQ0FBQztDQUNKLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb2ZpbGVTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL3NlcnZpY2UvcHJvZmlsZVwiXHJcbmltcG9ydCB7IHJlbnRhbCB9IGZyb20gXCIuLi8uLi9zZXJ2aWNlL3Byb3RvX2dlbi9yZW50YWwvcmVudGFsX3BiXCJcclxuaW1wb3J0IHsgZm9ybWF0RHVyYXRpb24sIHBhZFN0cmluZyB9IGZyb20gXCIuLi8uLi91dGlscy9mb3JtYXRcIlxyXG5pbXBvcnQgeyByb3V0aW5nIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JvdXRpbmdcIlxyXG5cclxuXHJcbmZ1bmN0aW9uIGZvcm1hdERhdGUobWlsbGlzOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGR0ID0gbmV3IERhdGUobWlsbGlzKVxyXG4gICAgY29uc3QgeSA9IGR0LmdldEZ1bGxZZWFyKClcclxuICAgIGNvbnN0IG0gPSBkdC5nZXRNb250aCgpICsgMVxyXG4gICAgY29uc3QgZCA9IGR0LmdldERhdGUoKVxyXG4gICAgcmV0dXJuIGAke3BhZFN0cmluZyh5KX0tJHtwYWRTdHJpbmcobSl9LSR7cGFkU3RyaW5nKGQpfWBcclxufVxyXG5cclxuUGFnZSh7XHJcbiAgICByZWRpcmVjdFVSTDogJycsXHJcbiAgICBwcm9maWxlUmVmcmVzaGVyOiAwLFxyXG4gICAgZGF0YToge1xyXG4gICAgICAgIGxpY05vOiAnJyxcclxuICAgICAgICBuYW1lOiAnJyxcclxuICAgICAgICBnZW5kZXJJbmRleDogMCxcclxuICAgICAgICBnZW5kZXJzOiBbJ+acquefpScsICfnlLcnLCAn5aWzJ10sXHJcbiAgICAgICAgYmlydGhEYXRlOiAnMTk5MC0wMS0wMScsXHJcbiAgICAgICAgbGljSW1nVVJMOiAnJyxcclxuICAgICAgICBzdGF0ZTogcmVudGFsLnYxLklkZW50aXR5U3RhdHVzW3JlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5VTlNVQk1JVFRFRF1cclxuICAgIH0sXHJcblxyXG4gICAgcmVuZGVyUHJvZmlsZShwOiByZW50YWwudjEuSVByb2ZpbGUpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBsaWNObzogcC5pZGVudGl0eT8ubGljTnVtYmVyIHx8ICcnLFxyXG4gICAgICAgICAgICBuYW1lOiBwLmlkZW50aXR5Py5uYW1lIHx8ICcnLFxyXG4gICAgICAgICAgICBnZW5kZXJJbmRleDogcC5pZGVudGl0eT8uZ2VuZGVyIHx8IDAsXHJcbiAgICAgICAgICAgIGJpcnRoRGF0ZTogZm9ybWF0RGF0ZShwLmlkZW50aXR5Py5icml0aERhdGVNaWxsaXMgfHwgMCksXHJcbiAgICAgICAgICAgIHN0YXRlOiByZW50YWwudjEuSWRlbnRpdHlTdGF0dXNbcC5pZGVudGl0eVN0YXR1cyB8fCAwXVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uTG9hZChvcHQ6IFJlY29yZDwncmVkaXJlY3QnLCBzdHJpbmc+KSB7XHJcbiAgICAgICAgY29uc3Qgbzogcm91dGluZy5SZWdpc3Rlck9wdHMgPSBvcHRcclxuICAgICAgICBpZiAoby5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICB0aGlzLnJlZGlyZWN0VVJMID0gZGVjb2RlVVJJQ29tcG9uZW50KG8ucmVkaXJlY3QpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBQcm9maWxlU2VydmljZS5nZXRQcm9maWxlKCkudGhlbihwID0+IHRoaXMucmVuZGVyUHJvZmlsZShwKSlcclxuICAgIH0sXHJcblxyXG4gICAgb25VbmxvYWQoKSB7XHJcbiAgICAgICAgdGhpcy5jbGVhclByb2ZpbGVSZWZyZXNoZXIoKVxyXG4gICAgfSxcclxuXHJcbiAgICBvblVwbG9hZExpYygpIHtcclxuICAgICAgICB3eC5jaG9vc2VJbWFnZSh7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLnRlbXBGaWxlUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpY0ltZ1VSTDogcmVzLnRlbXBGaWxlUGF0aHNbMF1cclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IHVwbG9hZCBsaWNcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKS5yZWFkRmlsZVN5bmMocmVzLnRlbXBGaWxlUGF0aHNbMF0pXHJcbiAgICAgICAgICAgICAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BVVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vY29vbGNhci0xMjU4NTI3NzE0LmNvcy5hcC1jaGVuZ2R1Lm15cWNsb3VkLmNvbS9hY2NvdW50XzcvNjIzOGFmZjE5MWQ0MDM0NjdhYzc4OTZiP3Etc2lnbi1hbGdvcml0aG09c2hhMSZxLWFrPUFLSURrSmRoWDdTWE55SlBKeU5XUTVVZFhCYWpkSGdwalF0NyZxLXNpZ24tdGltZT0xNjQ3ODgyMjI1JTNCMTY0Nzg4MzIyNSZxLWtleS10aW1lPTE2NDc4ODIyMjUlM0IxNjQ3ODgzMjI1JnEtaGVhZGVyLWxpc3Q9Y29udGVudC10eXBlJTNCaG9zdCZxLXVybC1wYXJhbS1saXN0PSZxLXNpZ25hdHVyZT1lNjFjZGY5YTAxMDg4Y2ZmYWRjNWYxMjQ2NzAxYzI0OTY3YzgwNjU2JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiB7J2NvbnRlbnQtdHlwZSc6ICdpbWFnZS9qcGVnJ30sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGNvbnNvbGUubG9nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmYWlsOiBjb25zb2xlLmVycm9yLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5YGH6K6+562J5LiA56eS5omN5ou/5Yiw6Kej5p6Q5a6MXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICBsaWNObzogJzMyNDM2MzMyNTQnLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgbmFtZTogJ+W8oOS4iScsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICBnZW5kZXJJbmRleDogMSxcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIGJpcnRoRGF0ZTogJzE5OTktMTItMjMnLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIH0sIDEwMDApXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgb25HZW5kZXJDaGFuZ2UoZTogYW55KSB7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgZ2VuZGVySW5kZXg6IHBhcnNlSW50KGUuZGV0YWlsLnZhbHVlKSxcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkJpcnRoRGF0ZUNoYW5nZShlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBiaXJ0aERhdGU6IGUuZGV0YWlsLnZhbHVlLFxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uU3VibWl0KCkge1xyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLnN1Ym1pbnRQcm9maWxlKHtcclxuICAgICAgICAgICAgbGljTnVtYmVyOiB0aGlzLmRhdGEubGljTm8sXHJcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuZGF0YS5uYW1lLFxyXG4gICAgICAgICAgICBnZW5kZXI6IHRoaXMuZGF0YS5nZW5kZXJJbmRleCxcclxuICAgICAgICAgICAgYnJpdGhEYXRlTWlsbGlzOiBEYXRlLnBhcnNlKHRoaXMuZGF0YS5iaXJ0aERhdGUpXHJcbiAgICAgICAgfSkudGhlbihwID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJQcm9maWxlKHApXHJcbiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVQcm9maWxlUmVmcmVzaGVyKClcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBzY2hlZHVsZVByb2ZpbGVSZWZyZXNoZXIoKSB7XHJcbiAgICAgICAgLy8g5q+P56eS6L+b6KGM6L2u6K+iXHJcbiAgICAgICAgdGhpcy5wcm9maWxlUmVmcmVzaGVyID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICBQcm9maWxlU2VydmljZS5nZXRQcm9maWxlKCkudGhlbihwID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyUHJvZmlsZShwKVxyXG4gICAgICAgICAgICAgICAgaWYgKHAuaWRlbnRpdHlTdGF0dXMgIT09IHJlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5QRU5ESU5HKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclByb2ZpbGVSZWZyZXNoZXIoKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHAuaWRlbnRpdHlTdGF0dXMgPT09IHJlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5WRVJJRklFRCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25MaWNWZXJpZmllZCgpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSwgMTAwMClcclxuICAgIH0sXHJcblxyXG4gICAgY2xlYXJQcm9maWxlUmVmcmVzaGVyKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnByb2ZpbGVSZWZyZXNoZXIpIHtcclxuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnByb2ZpbGVSZWZyZXNoZXIpXHJcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZVJlZnJlc2hlciA9IDBcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIG9uUmVTdWJtaXQoKSB7XHJcbiAgICAgICAgUHJvZmlsZVNlcnZpY2UuY2xlYXJQcm9maWxlKCkudGhlbihwID0+IHRoaXMucmVuZGVyUHJvZmlsZShwKSlcclxuICAgIH0sXHJcbiAgICBvbkxpY1ZlcmlmaWVkKCkge1xyXG4gICAgICAgIC8vIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgLy8gICAgIHN0YXRlOiAnVkVSSUZJRUQnLFxyXG4gICAgICAgIC8vIH0pXHJcbiAgICAgICAgaWYgKHRoaXMucmVkaXJlY3RVUkwpIHtcclxuICAgICAgICAgICAgd3gucmVkaXJlY3RUbyh7XHJcbiAgICAgICAgICAgICAgICB1cmw6IHRoaXMucmVkaXJlY3RVUkwsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxufSkiXX0=