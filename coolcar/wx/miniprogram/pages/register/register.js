"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const profile_1 = require("../../service/profile");
const rental_pb_1 = require("../../service/proto_gen/rental/rental_pb");
const request_1 = require("../../service/request");
const format_1 = require("../../utils/format");
function formatDate(millis) {
    const dt = new Date(millis);
    const y = dt.getFullYear();
    const m = dt.getMonth() + 1;
    const d = dt.getDate();
    return `${format_1.padString(y)}-${format_1.padString(m)}-${format_1.padString(d)}`;
}
Page({
    redirectURL: '',
    profileRefresher: 0,
    data: {
        licNo: '',
        name: '',
        genderIndex: 0,
        genders: ['未知', '男', '女'],
        birthDate: '1990-01-01',
        licImgURL: '',
        state: rental_pb_1.rental.v1.IdentityStatus[rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED]
    },
    renderProfile(p) {
        this.renderIdentity(p.identity);
        this.setData({
            state: rental_pb_1.rental.v1.IdentityStatus[p.identityStatus || 0]
        });
    },
    renderIdentity(i) {
        this.setData({
            licNo: (i === null || i === void 0 ? void 0 : i.licNumber) || '',
            name: (i === null || i === void 0 ? void 0 : i.name) || '',
            genderIndex: (i === null || i === void 0 ? void 0 : i.gender) || 0,
            birthDate: formatDate((i === null || i === void 0 ? void 0 : i.brithDateMillis) || 0),
        });
    },
    onLoad(opt) {
        const o = opt;
        if (o.redirect) {
            this.redirectURL = decodeURIComponent(o.redirect);
        }
        profile_1.ProfileService.getProfile().then(p => this.renderProfile(p));
        profile_1.ProfileService.getProfilePhoto().then(p => {
            wx.downloadFile({
                url: p.url || '',
                header: { 'Content-Type': 'image/jpeg' },
                success(res) {
                    if (res.statusCode === 200) {
                        console.log(res.tempFilePath);
                        wx.setStorageSync('licPicUrl', res.tempFilePath);
                    }
                    else {
                        wx.setStorageSync('licPicUrl', '');
                    }
                },
            });
            console.log("storage", wx.getStorageSync('licPicUrl'));
            this.setData({
                licImgURL: wx.getStorageSync('licPicUrl'),
            });
        });
    },
    onReady() {
        setTimeout(res => {
            console.log("onReady-storage", wx.getStorageSync('licPicUrl'));
            this.setData({
                licImgURL: wx.getStorageSync('licPicUrl'),
            });
        }, 2000);
    },
    onUnload() {
        this.clearProfileRefresher();
    },
    onUploadLic() {
        wx.chooseImage({
            success: (res) => __awaiter(this, void 0, void 0, function* () {
                if (res.tempFilePaths.length === 0) {
                    return;
                }
                this.setData({
                    licImgURL: res.tempFilePaths[0]
                });
                const photoRes = yield profile_1.ProfileService.createProfilePhoto();
                if (!photoRes.uploadUrl) {
                    return;
                }
                yield request_1.Coolcar.uploadfile({
                    localPath: res.tempFilePaths[0],
                    url: photoRes.uploadUrl,
                });
                const identity = yield profile_1.ProfileService.completeProfilePhoto();
                this.renderIdentity(identity);
            })
        });
    },
    onGenderChange(e) {
        this.setData({
            genderIndex: parseInt(e.detail.value),
        });
    },
    onBirthDateChange(e) {
        this.setData({
            birthDate: e.detail.value,
        });
    },
    onSubmit() {
        profile_1.ProfileService.submintProfile({
            licNumber: this.data.licNo,
            name: this.data.name,
            gender: this.data.genderIndex,
            brithDateMillis: Date.parse(this.data.birthDate)
        }).then(p => {
            this.renderProfile(p);
            this.scheduleProfileRefresher();
        });
    },
    scheduleProfileRefresher() {
        this.profileRefresher = setInterval(() => {
            profile_1.ProfileService.getProfile().then(p => {
                this.renderProfile(p);
                if (p.identityStatus !== rental_pb_1.rental.v1.IdentityStatus.PENDING) {
                    this.clearProfileRefresher();
                }
                if (p.identityStatus === rental_pb_1.rental.v1.IdentityStatus.VERIFIED) {
                    this.onLicVerified();
                }
            });
        }, 1000);
    },
    clearProfileRefresher() {
        if (this.profileRefresher) {
            clearInterval(this.profileRefresher);
            this.profileRefresher = 0;
        }
    },
    onReSubmit() {
        profile_1.ProfileService.clearProfile().then(p => this.renderProfile(p));
        profile_1.ProfileService.clearProfilePhoto().then(() => {
            this.setData({
                licImgURL: '',
            });
        });
        wx.setStorageSync('licPicUrl', '');
    },
    onLicVerified() {
        if (this.redirectURL) {
            wx.redirectTo({
                url: this.redirectURL,
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLG1EQUFzRDtBQUN0RCx3RUFBaUU7QUFDakUsbURBQStDO0FBQy9DLCtDQUE4RDtBQUk5RCxTQUFTLFVBQVUsQ0FBQyxNQUFjO0lBQzlCLE1BQU0sRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzNCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUMxQixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQzNCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUN0QixPQUFPLEdBQUcsa0JBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxrQkFBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLGtCQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUM1RCxDQUFDO0FBRUQsSUFBSSxDQUFDO0lBQ0QsV0FBVyxFQUFFLEVBQUU7SUFDZixnQkFBZ0IsRUFBRSxDQUFDO0lBQ25CLElBQUksRUFBRTtRQUNGLEtBQUssRUFBRSxFQUFFO1FBQ1QsSUFBSSxFQUFFLEVBQUU7UUFDUixXQUFXLEVBQUUsQ0FBQztRQUNkLE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQ3pCLFNBQVMsRUFBRSxZQUFZO1FBQ3ZCLFNBQVMsRUFBRSxFQUFFO1FBQ2IsS0FBSyxFQUFFLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDO0tBQ3hFO0lBRUQsYUFBYSxDQUFDLENBQXFCO1FBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLFFBQVMsQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FB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QUFJLENBQUMsR0FBRyxFQUFFO1lBQ3pDLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1QsU0FBUyxFQUFFLEVBQUU7YUFDaEIsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBQ0QsYUFBYTtRQUlULElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixFQUFFLENBQUMsVUFBVSxDQUFDO2dCQUNWLEdBQUcsRUFBRSxJQUFJLENBQUMsV0FBVzthQUN4QixDQUFDLENBQUE7U0FDTDtJQUVMLENBQUM7Q0FDSixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm9maWxlU2VydmljZSB9IGZyb20gXCIuLi8uLi9zZXJ2aWNlL3Byb2ZpbGVcIlxyXG5pbXBvcnQgeyByZW50YWwgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9wcm90b19nZW4vcmVudGFsL3JlbnRhbF9wYlwiXHJcbmltcG9ydCB7IENvb2xjYXIgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9yZXF1ZXN0XCJcclxuaW1wb3J0IHsgZm9ybWF0RHVyYXRpb24sIHBhZFN0cmluZyB9IGZyb20gXCIuLi8uLi91dGlscy9mb3JtYXRcIlxyXG5pbXBvcnQgeyByb3V0aW5nIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JvdXRpbmdcIlxyXG5cclxuXHJcbmZ1bmN0aW9uIGZvcm1hdERhdGUobWlsbGlzOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGR0ID0gbmV3IERhdGUobWlsbGlzKVxyXG4gICAgY29uc3QgeSA9IGR0LmdldEZ1bGxZZWFyKClcclxuICAgIGNvbnN0IG0gPSBkdC5nZXRNb250aCgpICsgMVxyXG4gICAgY29uc3QgZCA9IGR0LmdldERhdGUoKVxyXG4gICAgcmV0dXJuIGAke3BhZFN0cmluZyh5KX0tJHtwYWRTdHJpbmcobSl9LSR7cGFkU3RyaW5nKGQpfWBcclxufVxyXG5cclxuUGFnZSh7XHJcbiAgICByZWRpcmVjdFVSTDogJycsXHJcbiAgICBwcm9maWxlUmVmcmVzaGVyOiAwLFxyXG4gICAgZGF0YToge1xyXG4gICAgICAgIGxpY05vOiAnJyxcclxuICAgICAgICBuYW1lOiAnJyxcclxuICAgICAgICBnZW5kZXJJbmRleDogMCxcclxuICAgICAgICBnZW5kZXJzOiBbJ+acquefpScsICfnlLcnLCAn5aWzJ10sXHJcbiAgICAgICAgYmlydGhEYXRlOiAnMTk5MC0wMS0wMScsXHJcbiAgICAgICAgbGljSW1nVVJMOiAnJyxcclxuICAgICAgICBzdGF0ZTogcmVudGFsLnYxLklkZW50aXR5U3RhdHVzW3JlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5VTlNVQk1JVFRFRF1cclxuICAgIH0sXHJcblxyXG4gICAgcmVuZGVyUHJvZmlsZShwOiByZW50YWwudjEuSVByb2ZpbGUpIHtcclxuICAgICAgICB0aGlzLnJlbmRlcklkZW50aXR5KHAuaWRlbnRpdHkhKVxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIHN0YXRlOiByZW50YWwudjEuSWRlbnRpdHlTdGF0dXNbcC5pZGVudGl0eVN0YXR1cyB8fCAwXVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuXHJcbiAgICByZW5kZXJJZGVudGl0eShpPzogcmVudGFsLnYxLklJZGVudGl0eSkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGxpY05vOiBpPy5saWNOdW1iZXIgfHwgJycsXHJcbiAgICAgICAgICAgIG5hbWU6IGk/Lm5hbWUgfHwgJycsXHJcbiAgICAgICAgICAgIGdlbmRlckluZGV4OiBpPy5nZW5kZXIgfHwgMCxcclxuICAgICAgICAgICAgYmlydGhEYXRlOiBmb3JtYXREYXRlKGk/LmJyaXRoRGF0ZU1pbGxpcyB8fCAwKSxcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkxvYWQob3B0OiBSZWNvcmQ8J3JlZGlyZWN0Jywgc3RyaW5nPikge1xyXG4gICAgICAgIGNvbnN0IG86IHJvdXRpbmcuUmVnaXN0ZXJPcHRzID0gb3B0XHJcbiAgICAgICAgaWYgKG8ucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFVSTCA9IGRlY29kZVVSSUNvbXBvbmVudChvLnJlZGlyZWN0KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g55yLIOaYr+WQpuacieS/oeaBr1xyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKS50aGVuKHAgPT4gdGhpcy5yZW5kZXJQcm9maWxlKHApKVxyXG4gICAgICAgIC8vIOWGjeaLvyB1cmwg5aaC5p6c5pyJXHJcbiAgICAgICAgUHJvZmlsZVNlcnZpY2UuZ2V0UHJvZmlsZVBob3RvKCkudGhlbihwID0+IHtcclxuXHJcbiAgICAgICAgICAgIC8vIOagueaNruaLv+WIsOeahFVSTOWItuS9nOS4i+i9veivt+axglxyXG4gICAgICAgICAgICAvLyDnlKjkuo7mtYvor5Xojrflj5blm77niYdVUkxcclxuICAgICAgICAgICAgLy9sZXQgbGljX3VybF90ZXN0OiBzdHJpbmcgPSAnJ1xyXG4gICAgICAgICAgICAvLyBsZXQgaGFzVVJMOiBib29sZWFuID0gZmFsc2VcclxuICAgICAgICAgICAgLy8g5rWL6K+V6I635Y+WXHJcbiAgICAgICAgICAgIHd4LmRvd25sb2FkRmlsZSh7XHJcbiAgICAgICAgICAgICAgICB1cmw6IHAudXJsIHx8ICcnLCAgIC8vIOWmguaenOepuiDlsLHmmK80MDRcclxuICAgICAgICAgICAgICAgIGhlYWRlcjogeyAnQ29udGVudC1UeXBlJzogJ2ltYWdlL2pwZWcnIH0sXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzKHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWPquimgeacjeWKoeWZqOacieWTjeW6lOaVsOaNru+8jOWwseS8muaKiuWTjeW6lOWGheWuueWGmeWFpeaWh+S7tuW5tui/m+WFpSBzdWNjZXNzIOWbnuiwg++8jOS4muWKoemcgOimgeiHquihjOWIpOaWreaYr+WQpuS4i+i9veWIsOS6huaDs+imgeeahOWGheWuuVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcy50ZW1wRmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOebtOaOpSBzZXQg5Yiw5Zu+54mH6Lev5b6EXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdsaWNQaWNVcmwnLCByZXMudGVtcEZpbGVQYXRoKVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3eC5zZXRTdG9yYWdlU3luYygnbGljUGljVXJsJywgJycpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH0sXHJcblxyXG5cclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic3RvcmFnZVwiLCB3eC5nZXRTdG9yYWdlU3luYygnbGljUGljVXJsJykpXHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBsaWNJbWdVUkw6IHd4LmdldFN0b3JhZ2VTeW5jKCdsaWNQaWNVcmwnKSxcclxuICAgICAgICAgICAgfSlcclxuXHJcblxyXG4gICAgICAgICAgICAvLyBlbHNlIHtcclxuICAgICAgICAgICAgLy8gICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgbGljSW1nVVJMOicnLFxyXG4gICAgICAgICAgICAvLyAgICAgfSlcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uUmVhZHkoKSB7XHJcbiAgICAgICAgLy8g6YG/5YWNIOayoeaciSBsb2FkIOWujOeahOaXtuWAmSDlsLHot7Pov4fkuoZcclxuICAgICAgICAvLyDmiYDku6Xov5nph4zlho3ov5vooYzkuIDmrKHotYvlgLxcclxuICAgICAgICAvLyDov5nnp43lgZrms5XnmoTpl67popjmmK/vvJog5Zu+54mH5Lya6Zeq5LiA5LiL77yMIOWboOS4uuacieWPr+iDveWKoOi9veS6huS4pOasoVxyXG4gICAgICAgIHNldFRpbWVvdXQocmVzID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJvblJlYWR5LXN0b3JhZ2VcIiwgd3guZ2V0U3RvcmFnZVN5bmMoJ2xpY1BpY1VybCcpKVxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgbGljSW1nVVJMOiB3eC5nZXRTdG9yYWdlU3luYygnbGljUGljVXJsJyksXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSwgMjAwMClcclxuXHJcbiAgICB9LFxyXG5cclxuICAgIG9uVW5sb2FkKCkge1xyXG4gICAgICAgIHRoaXMuY2xlYXJQcm9maWxlUmVmcmVzaGVyKClcclxuICAgIH0sXHJcblxyXG4gICAgb25VcGxvYWRMaWMoKSB7XHJcblxyXG4gICAgICAgIHd4LmNob29zZUltYWdlKHtcclxuICAgICAgICAgICAgc3VjY2VzczogYXN5bmMgcmVzID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXMudGVtcEZpbGVQYXRocy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgICAgIGxpY0ltZ1VSTDogcmVzLnRlbXBGaWxlUGF0aHNbMF1cclxuICAgICAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgcGhvdG9SZXMgPSBhd2FpdCBQcm9maWxlU2VydmljZS5jcmVhdGVQcm9maWxlUGhvdG8oKVxyXG4gICAgICAgICAgICAgICAgaWYgKCFwaG90b1Jlcy51cGxvYWRVcmwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGF3YWl0IENvb2xjYXIudXBsb2FkZmlsZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxQYXRoOiByZXMudGVtcEZpbGVQYXRoc1swXSxcclxuICAgICAgICAgICAgICAgICAgICB1cmw6IHBob3RvUmVzLnVwbG9hZFVybCxcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZGVudGl0eSA9IGF3YWl0IFByb2ZpbGVTZXJ2aWNlLmNvbXBsZXRlUHJvZmlsZVBob3RvKClcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVySWRlbnRpdHkoaWRlbnRpdHkpXHJcblxyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogdXBsb2FkIGxpY1xyXG4gICAgICAgICAgICAgICAgLy8gY29uc3QgZGF0YSA9IHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKCkucmVhZEZpbGVTeW5jKHJlcy50ZW1wRmlsZVBhdGhzWzBdKVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIC8vIOa1i+ivleS4iuS8oFxyXG4gICAgICAgICAgICAgICAgLy8gd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgbWV0aG9kOiAnUFVUJyxcclxuICAgICAgICAgICAgICAgIC8vICAgICB1cmw6ICdodHRwOi8vY29vbGNhci1semwub3NzLWNuLWJlaWppbmcuYWxpeXVuY3MuY29tL2FjY291bnRfOTYyM2FlZjRiZjU2ZWZhYzM3YjQ0ZjIxNz9FeHBpcmVzPTE2NDgwMzA1MTUmT1NTQWNjZXNzS2V5SWQ9TFRBSTV0TEs4Q2tjN3VQZ2t4VEZoNWFCJlNpZ25hdHVyZT0lMkZCOVhmd2lUb0FlcU8wd3BUbkJPb3JtQnA3USUzRCcsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgICAgIC8vICAgICBoZWFkZXI6IHsnQ29udGVudC1UeXBlJzogJ2ltYWdlL2pwZWcnfSxcclxuICAgICAgICAgICAgICAgIC8vICAgICBzdWNjZXNzOiBjb25zb2xlLmxvZyxcclxuICAgICAgICAgICAgICAgIC8vICAgICBmYWlsOiBjb25zb2xlLmVycm9yLFxyXG4gICAgICAgICAgICAgICAgLy8gfSlcclxuXHJcblxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAvLyDlgYforr7nrYnkuIDnp5LmiY3mi7/liLDop6PmnpDlroxcclxuICAgICAgICAgICAgICAgIC8vIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgIGxpY05vOiAnMzI0MzYzMzI1NCcsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgIG5hbWU6ICflvKDkuIknLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICBnZW5kZXJJbmRleDogMSxcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgYmlydGhEYXRlOiAnMTk5OS0xMi0yMycsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgfSlcclxuICAgICAgICAgICAgICAgIC8vIH0sIDEwMDApXHJcblxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uR2VuZGVyQ2hhbmdlKGU6IGFueSkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGdlbmRlckluZGV4OiBwYXJzZUludChlLmRldGFpbC52YWx1ZSksXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgb25CaXJ0aERhdGVDaGFuZ2UoZTogYW55KSB7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgYmlydGhEYXRlOiBlLmRldGFpbC52YWx1ZSxcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvblN1Ym1pdCgpIHtcclxuICAgICAgICBQcm9maWxlU2VydmljZS5zdWJtaW50UHJvZmlsZSh7XHJcbiAgICAgICAgICAgIGxpY051bWJlcjogdGhpcy5kYXRhLmxpY05vLFxyXG4gICAgICAgICAgICBuYW1lOiB0aGlzLmRhdGEubmFtZSxcclxuICAgICAgICAgICAgZ2VuZGVyOiB0aGlzLmRhdGEuZ2VuZGVySW5kZXgsXHJcbiAgICAgICAgICAgIGJyaXRoRGF0ZU1pbGxpczogRGF0ZS5wYXJzZSh0aGlzLmRhdGEuYmlydGhEYXRlKVxyXG4gICAgICAgIH0pLnRoZW4ocCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyUHJvZmlsZShwKVxyXG4gICAgICAgICAgICB0aGlzLnNjaGVkdWxlUHJvZmlsZVJlZnJlc2hlcigpXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgc2NoZWR1bGVQcm9maWxlUmVmcmVzaGVyKCkge1xyXG4gICAgICAgIC8vIOavj+enkui/m+ihjOi9ruivolxyXG4gICAgICAgIHRoaXMucHJvZmlsZVJlZnJlc2hlciA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgUHJvZmlsZVNlcnZpY2UuZ2V0UHJvZmlsZSgpLnRoZW4ocCA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclByb2ZpbGUocClcclxuICAgICAgICAgICAgICAgIGlmIChwLmlkZW50aXR5U3RhdHVzICE9PSByZW50YWwudjEuSWRlbnRpdHlTdGF0dXMuUEVORElORykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJQcm9maWxlUmVmcmVzaGVyKClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChwLmlkZW50aXR5U3RhdHVzID09PSByZW50YWwudjEuSWRlbnRpdHlTdGF0dXMuVkVSSUZJRUQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTGljVmVyaWZpZWQoKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0sIDEwMDApXHJcbiAgICB9LFxyXG5cclxuICAgIGNsZWFyUHJvZmlsZVJlZnJlc2hlcigpIHtcclxuICAgICAgICBpZiAodGhpcy5wcm9maWxlUmVmcmVzaGVyKSB7XHJcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5wcm9maWxlUmVmcmVzaGVyKVxyXG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVSZWZyZXNoZXIgPSAwXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBvblJlU3VibWl0KCkge1xyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLmNsZWFyUHJvZmlsZSgpLnRoZW4ocCA9PiB0aGlzLnJlbmRlclByb2ZpbGUocCkpXHJcbiAgICAgICAgUHJvZmlsZVNlcnZpY2UuY2xlYXJQcm9maWxlUGhvdG8oKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIGxpY0ltZ1VSTDogJycsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuICAgICAgICAvLyDkuI3opoHlv5jorrDmuIXkuIDkuIvnvJPlrZhcclxuICAgICAgICB3eC5zZXRTdG9yYWdlU3luYygnbGljUGljVXJsJywgJycpXHJcbiAgICB9LFxyXG4gICAgb25MaWNWZXJpZmllZCgpIHtcclxuICAgICAgICAvLyB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgIC8vICAgICBzdGF0ZTogJ1ZFUklGSUVEJyxcclxuICAgICAgICAvLyB9KVxyXG4gICAgICAgIGlmICh0aGlzLnJlZGlyZWN0VVJMKSB7XHJcbiAgICAgICAgICAgIHd4LnJlZGlyZWN0VG8oe1xyXG4gICAgICAgICAgICAgICAgdXJsOiB0aGlzLnJlZGlyZWN0VVJMLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcbn0pIl19