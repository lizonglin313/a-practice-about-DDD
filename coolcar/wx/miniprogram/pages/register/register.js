"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const profile_1 = require("../../service/profile");
const rental_pb_1 = require("../../service/proto_gen/rental/rental_pb");
const request_1 = require("../../service/request");
const format_1 = require("../../utils/format");
function formatDate(millis) {
    const dt = new Date(millis);
    const y = dt.getFullYear();
    const m = dt.getMonth() + 1;
    const d = dt.getDate();
    return `${format_1.padString(y)}-${format_1.padString(m)}-${format_1.padString(d)}`;
}
Page({
    redirectURL: '',
    profileRefresher: 0,
    data: {
        licNo: '',
        name: '',
        genderIndex: 0,
        genders: ['未知', '男', '女'],
        birthDate: '1990-01-01',
        licImgURL: '',
        state: rental_pb_1.rental.v1.IdentityStatus[rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED]
    },
    renderProfile(p) {
        this.renderIdentity(p.identity);
        this.setData({
            state: rental_pb_1.rental.v1.IdentityStatus[p.identityStatus || 0]
        });
    },
    renderIdentity(i) {
        this.setData({
            licNo: (i === null || i === void 0 ? void 0 : i.licNumber) || '',
            name: (i === null || i === void 0 ? void 0 : i.name) || '',
            genderIndex: (i === null || i === void 0 ? void 0 : i.gender) || 0,
            birthDate: formatDate((i === null || i === void 0 ? void 0 : i.brithDateMillis) || 0),
        });
    },
    onLoad(opt) {
        const o = opt;
        if (o.redirect) {
            this.redirectURL = decodeURIComponent(o.redirect);
        }
        profile_1.ProfileService.getProfile().then(p => this.renderProfile(p));
        profile_1.ProfileService.getProfilePhoto().then(p => {
            wx.downloadFile({
                url: p.url || '',
                header: { 'Content-Type': 'image/jpeg' },
                success(res) {
                    if (res.statusCode === 200) {
                        console.log(res.tempFilePath);
                        wx.setStorageSync('licPicUrl', res.tempFilePath);
                    }
                    else {
                        wx.setStorageSync('licPicUrl', '');
                    }
                },
            });
            console.log("storage", wx.getStorageSync('licPicUrl'));
            this.setData({
                licImgURL: wx.getStorageSync('licPicUrl'),
            });
        });
    },
    onReady() {
        setTimeout(res => {
            console.log("onReady-storage", wx.getStorageSync('licPicUrl'));
            this.setData({
                licImgURL: wx.getStorageSync('licPicUrl'),
            });
        }, 2000);
    },
    onUnload() {
        this.clearProfileRefresher();
    },
    onUploadLic() {
        wx.chooseImage({
            success: (res) => __awaiter(this, void 0, void 0, function* () {
                if (res.tempFilePaths.length === 0) {
                    return;
                }
                this.setData({
                    licImgURL: res.tempFilePaths[0]
                });
                const photoRes = yield profile_1.ProfileService.createProfilePhoto();
                if (!photoRes.uploadUrl) {
                    return;
                }
                yield request_1.Coolcar.uploadfile({
                    localPath: res.tempFilePaths[0],
                    url: photoRes.uploadUrl,
                });
                const identity = yield profile_1.ProfileService.completeProfilePhoto();
                this.renderIdentity(identity);
            })
        });
    },
    onGenderChange(e) {
        this.setData({
            genderIndex: parseInt(e.detail.value),
        });
    },
    onBirthDateChange(e) {
        this.setData({
            birthDate: e.detail.value,
        });
    },
    onSubmit() {
        profile_1.ProfileService.submintProfile({
            licNumber: this.data.licNo,
            name: this.data.name,
            gender: this.data.genderIndex,
            brithDateMillis: Date.parse(this.data.birthDate)
        }).then(p => {
            this.renderProfile(p);
            this.scheduleProfileRefresher();
        });
    },
    scheduleProfileRefresher() {
        this.profileRefresher = setInterval(() => {
            profile_1.ProfileService.getProfile().then(p => {
                this.renderProfile(p);
                if (p.identityStatus !== rental_pb_1.rental.v1.IdentityStatus.PENDING) {
                    this.clearProfileRefresher();
                }
                if (p.identityStatus === rental_pb_1.rental.v1.IdentityStatus.VERIFIED) {
                    this.onLicVerified();
                }
            });
        }, 1000);
    },
    clearProfileRefresher() {
        if (this.profileRefresher) {
            clearInterval(this.profileRefresher);
            this.profileRefresher = 0;
        }
    },
    onReSubmit() {
        profile_1.ProfileService.clearProfile().then(p => this.renderProfile(p));
        profile_1.ProfileService.clearProfilePhoto().then(() => {
            this.setData({
                licImgURL: '',
            });
        });
        wx.setStorageSync('licPicUrl', '');
    },
    onLicVerified() {
        if (this.redirectURL) {
            wx.redirectTo({
                url: this.redirectURL,
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLG1EQUFzRDtBQUN0RCx3RUFBaUU7QUFDakUsbURBQStDO0FBQy9DLCtDQUE4RDtBQUk5RCxTQUFTLFVBQVUsQ0FBQyxNQUFjO0lBQzlCLE1BQU0sRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzNCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUMxQixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQzNCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUN0QixPQUFPLEdBQUcsa0JBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxrQkFBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLGtCQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUM1RCxDQUFDO0FBRUQsSUFBSSxDQUFDO0lBQ0QsV0FBVyxFQUFFLEVBQUU7SUFDZixnQkFBZ0IsRUFBRSxDQUFDO0lBQ25CLElBQUksRUFBRTtRQUNGLEtBQUssRUFBRSxFQUFFO1FBQ1QsSUFBSSxFQUFFLEVBQUU7UUFDUixXQUFXLEVBQUUsQ0FBQztRQUNkLE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQ3pCLFNBQVMsRUFBRSxZQUFZO1FBQ3ZCLFNBQVMsRUFBRSxFQUFFO1FBQ2IsS0FBSyxFQUFFLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDO0tBQ3hFO0lBRUQsYUFBYSxDQUFDLENBQXFCO1FBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLFFBQVMsQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FB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QUFJLENBQUMsR0FBRyxFQUFFO1lBQ3pDLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1QsU0FBUyxFQUFFLEVBQUU7YUFDaEIsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBQ0QsYUFBYTtRQUlULElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixFQUFFLENBQUMsVUFBVSxDQUFDO2dCQUNWLEdBQUcsRUFBRSxJQUFJLENBQUMsV0FBVzthQUN4QixDQUFDLENBQUE7U0FDTDtJQUVMLENBQUM7Q0FDSixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm9maWxlU2VydmljZSB9IGZyb20gXCIuLi8uLi9zZXJ2aWNlL3Byb2ZpbGVcIlxyXG5pbXBvcnQgeyByZW50YWwgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9wcm90b19nZW4vcmVudGFsL3JlbnRhbF9wYlwiXHJcbmltcG9ydCB7IENvb2xjYXIgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9yZXF1ZXN0XCJcclxuaW1wb3J0IHsgZm9ybWF0RHVyYXRpb24sIHBhZFN0cmluZyB9IGZyb20gXCIuLi8uLi91dGlscy9mb3JtYXRcIlxyXG5pbXBvcnQgeyByb3V0aW5nIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JvdXRpbmdcIlxyXG5cclxuXHJcbmZ1bmN0aW9uIGZvcm1hdERhdGUobWlsbGlzOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGR0ID0gbmV3IERhdGUobWlsbGlzKVxyXG4gICAgY29uc3QgeSA9IGR0LmdldEZ1bGxZZWFyKClcclxuICAgIGNvbnN0IG0gPSBkdC5nZXRNb250aCgpICsgMVxyXG4gICAgY29uc3QgZCA9IGR0LmdldERhdGUoKVxyXG4gICAgcmV0dXJuIGAke3BhZFN0cmluZyh5KX0tJHtwYWRTdHJpbmcobSl9LSR7cGFkU3RyaW5nKGQpfWBcclxufVxyXG5cclxuUGFnZSh7XHJcbiAgICByZWRpcmVjdFVSTDogJycsXHJcbiAgICBwcm9maWxlUmVmcmVzaGVyOiAwLFxyXG4gICAgZGF0YToge1xyXG4gICAgICAgIGxpY05vOiAnJyxcclxuICAgICAgICBuYW1lOiAnJyxcclxuICAgICAgICBnZW5kZXJJbmRleDogMCxcclxuICAgICAgICBnZW5kZXJzOiBbJ+acquefpScsICfnlLcnLCAn5aWzJ10sXHJcbiAgICAgICAgYmlydGhEYXRlOiAnMTk5MC0wMS0wMScsXHJcbiAgICAgICAgbGljSW1nVVJMOiAnJyxcclxuICAgICAgICBzdGF0ZTogcmVudGFsLnYxLklkZW50aXR5U3RhdHVzW3JlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5VTlNVQk1JVFRFRF1cclxuICAgIH0sXHJcblxyXG4gICAgcmVuZGVyUHJvZmlsZShwOiByZW50YWwudjEuSVByb2ZpbGUpIHtcclxuICAgICAgICB0aGlzLnJlbmRlcklkZW50aXR5KHAuaWRlbnRpdHkhKVxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIHN0YXRlOiByZW50YWwudjEuSWRlbnRpdHlTdGF0dXNbcC5pZGVudGl0eVN0YXR1cyB8fCAwXVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuXHJcbiAgICByZW5kZXJJZGVudGl0eShpPzogcmVudGFsLnYxLklJZGVudGl0eSkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGxpY05vOiBpPy5saWNOdW1iZXIgfHwgJycsXHJcbiAgICAgICAgICAgIG5hbWU6IGk/Lm5hbWUgfHwgJycsXHJcbiAgICAgICAgICAgIGdlbmRlckluZGV4OiBpPy5nZW5kZXIgfHwgMCxcclxuICAgICAgICAgICAgYmlydGhEYXRlOiBmb3JtYXREYXRlKGk/LmJyaXRoRGF0ZU1pbGxpcyB8fCAwKSxcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkxvYWQob3B0OiBSZWNvcmQ8J3JlZGlyZWN0Jywgc3RyaW5nPikge1xyXG4gICAgICAgIGNvbnN0IG86IHJvdXRpbmcuUmVnaXN0ZXJPcHRzID0gb3B0XHJcbiAgICAgICAgaWYgKG8ucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFVSTCA9IGRlY29kZVVSSUNvbXBvbmVudChvLnJlZGlyZWN0KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g55yLIOaYr+WQpuacieS/oeaBr1xyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKS50aGVuKHAgPT4gdGhpcy5yZW5kZXJQcm9maWxlKHApKVxyXG4gICAgICAgIC8vIOWGjeaLvyB1cmwg5aaC5p6c5pyJXHJcbiAgICAgICAgUHJvZmlsZVNlcnZpY2UuZ2V0UHJvZmlsZVBob3RvKCkudGhlbihwID0+IHtcclxuXHJcbiAgICAgICAgICAgIC8vIOagueaNruaLv+WIsOeahFVSTOWItuS9nOS4i+i9veivt+axglxyXG4gICAgICAgICAgICAvLyDnlKjkuo7mtYvor5Xojrflj5blm77niYdVUkxcclxuICAgICAgICAgICAgLy9sZXQgbGljX3VybF90ZXN0OiBzdHJpbmcgPSAnJ1xyXG4gICAgICAgICAgICAvLyBsZXQgaGFzVVJMOiBib29sZWFuID0gZmFsc2VcclxuICAgICAgICAgICAgLy8g5rWL6K+V6I635Y+WXHJcbiAgICAgICAgICAgIHd4LmRvd25sb2FkRmlsZSh7XHJcbiAgICAgICAgICAgICAgICB1cmw6IHAudXJsIHx8ICcnLCAgIC8vIOWmguaenOepuiDlsLHmmK80MDRcclxuICAgICAgICAgICAgICAgIGhlYWRlcjogeyAnQ29udGVudC1UeXBlJzogJ2ltYWdlL2pwZWcnIH0sXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzKHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWPquimgeacjeWKoeWZqOacieWTjeW6lOaVsOaNru+8jOWwseS8muaKiuWTjeW6lOWGheWuueWGmeWFpeaWh+S7tuW5tui/m+WFpSBzdWNjZXNzIOWbnuiwg++8jOS4muWKoemcgOimgeiHquihjOWIpOaWreaYr+WQpuS4i+i9veWIsOS6huaDs+imgeeahOWGheWuuVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcy50ZW1wRmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOebtOaOpSBzZXQg5Yiw5Zu+54mH6Lev5b6EXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdsaWNQaWNVcmwnLCByZXMudGVtcEZpbGVQYXRoKVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3eC5zZXRTdG9yYWdlU3luYygnbGljUGljVXJsJywgJycpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH0sXHJcblxyXG5cclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic3RvcmFnZVwiLCB3eC5nZXRTdG9yYWdlU3luYygnbGljUGljVXJsJykpXHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBsaWNJbWdVUkw6IHd4LmdldFN0b3JhZ2VTeW5jKCdsaWNQaWNVcmwnKSxcclxuICAgICAgICAgICAgfSlcclxuXHJcblxyXG4gICAgICAgICAgICAvLyBlbHNlIHtcclxuICAgICAgICAgICAgLy8gICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgbGljSW1nVVJMOicnLFxyXG4gICAgICAgICAgICAvLyAgICAgfSlcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uUmVhZHkoKSB7XHJcbiAgICAgICAgLy8g6YG/5YWNIOayoeaciSBsb2FkIOWujOeahOaXtuWAmSDlsLHot7Pov4fkuoZcclxuICAgICAgICAvLyDmiYDku6Xov5nph4zlho3ov5vooYzkuIDmrKHotYvlgLxcclxuICAgICAgICBzZXRUaW1lb3V0KHJlcyA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwib25SZWFkeS1zdG9yYWdlXCIsIHd4LmdldFN0b3JhZ2VTeW5jKCdsaWNQaWNVcmwnKSlcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIGxpY0ltZ1VSTDogd3guZ2V0U3RvcmFnZVN5bmMoJ2xpY1BpY1VybCcpLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0sIDIwMDApXHJcblxyXG4gICAgfSxcclxuXHJcbiAgICBvblVubG9hZCgpIHtcclxuICAgICAgICB0aGlzLmNsZWFyUHJvZmlsZVJlZnJlc2hlcigpXHJcbiAgICB9LFxyXG5cclxuICAgIG9uVXBsb2FkTGljKCkge1xyXG5cclxuICAgICAgICB3eC5jaG9vc2VJbWFnZSh7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGFzeW5jIHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLnRlbXBGaWxlUGF0aHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICBsaWNJbWdVUkw6IHJlcy50ZW1wRmlsZVBhdGhzWzBdXHJcbiAgICAgICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHBob3RvUmVzID0gYXdhaXQgUHJvZmlsZVNlcnZpY2UuY3JlYXRlUHJvZmlsZVBob3RvKClcclxuICAgICAgICAgICAgICAgIGlmICghcGhvdG9SZXMudXBsb2FkVXJsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBDb29sY2FyLnVwbG9hZGZpbGUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsUGF0aDogcmVzLnRlbXBGaWxlUGF0aHNbMF0sXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBwaG90b1Jlcy51cGxvYWRVcmwsXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgY29uc3QgaWRlbnRpdHkgPSBhd2FpdCBQcm9maWxlU2VydmljZS5jb21wbGV0ZVByb2ZpbGVQaG90bygpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcklkZW50aXR5KGlkZW50aXR5KVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IHVwbG9hZCBsaWNcclxuICAgICAgICAgICAgICAgIC8vIGNvbnN0IGRhdGEgPSB3eC5nZXRGaWxlU3lzdGVtTWFuYWdlcigpLnJlYWRGaWxlU3luYyhyZXMudGVtcEZpbGVQYXRoc1swXSlcclxuXHJcbiAgICAgICAgICAgICAgICAvLyAvLyDmtYvor5XkuIrkvKBcclxuICAgICAgICAgICAgICAgIC8vIHd4LnJlcXVlc3Qoe1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIG1ldGhvZDogJ1BVVCcsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgdXJsOiAnaHR0cDovL2Nvb2xjYXItbHpsLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9hY2NvdW50Xzk2MjNhZWY0YmY1NmVmYWMzN2I0NGYyMTc/RXhwaXJlcz0xNjQ4MDMwNTE1Jk9TU0FjY2Vzc0tleUlkPUxUQUk1dExLOENrYzd1UGdreFRGaDVhQiZTaWduYXR1cmU9JTJGQjlYZndpVG9BZXFPMHdwVG5CT29ybUJwN1ElM0QnLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgaGVhZGVyOiB7J0NvbnRlbnQtVHlwZSc6ICdpbWFnZS9qcGVnJ30sXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgc3VjY2VzczogY29uc29sZS5sb2csXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgZmFpbDogY29uc29sZS5lcnJvcixcclxuICAgICAgICAgICAgICAgIC8vIH0pXHJcblxyXG5cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgLy8g5YGH6K6+562J5LiA56eS5omN5ou/5Yiw6Kej5p6Q5a6MXHJcbiAgICAgICAgICAgICAgICAvLyBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICBsaWNObzogJzMyNDM2MzMyNTQnLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICBuYW1lOiAn5byg5LiJJyxcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgZ2VuZGVySW5kZXg6IDEsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgIGJpcnRoRGF0ZTogJzE5OTktMTItMjMnLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgIH0pXHJcbiAgICAgICAgICAgICAgICAvLyB9LCAxMDAwKVxyXG5cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkdlbmRlckNoYW5nZShlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBnZW5kZXJJbmRleDogcGFyc2VJbnQoZS5kZXRhaWwudmFsdWUpLFxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uQmlydGhEYXRlQ2hhbmdlKGU6IGFueSkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGJpcnRoRGF0ZTogZS5kZXRhaWwudmFsdWUsXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgb25TdWJtaXQoKSB7XHJcbiAgICAgICAgUHJvZmlsZVNlcnZpY2Uuc3VibWludFByb2ZpbGUoe1xyXG4gICAgICAgICAgICBsaWNOdW1iZXI6IHRoaXMuZGF0YS5saWNObyxcclxuICAgICAgICAgICAgbmFtZTogdGhpcy5kYXRhLm5hbWUsXHJcbiAgICAgICAgICAgIGdlbmRlcjogdGhpcy5kYXRhLmdlbmRlckluZGV4LFxyXG4gICAgICAgICAgICBicml0aERhdGVNaWxsaXM6IERhdGUucGFyc2UodGhpcy5kYXRhLmJpcnRoRGF0ZSlcclxuICAgICAgICB9KS50aGVuKHAgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlclByb2ZpbGUocClcclxuICAgICAgICAgICAgdGhpcy5zY2hlZHVsZVByb2ZpbGVSZWZyZXNoZXIoKVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIHNjaGVkdWxlUHJvZmlsZVJlZnJlc2hlcigpIHtcclxuICAgICAgICAvLyDmr4/np5Lov5vooYzova7or6JcclxuICAgICAgICB0aGlzLnByb2ZpbGVSZWZyZXNoZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgICAgICAgIFByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKS50aGVuKHAgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJQcm9maWxlKHApXHJcbiAgICAgICAgICAgICAgICBpZiAocC5pZGVudGl0eVN0YXR1cyAhPT0gcmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlBFTkRJTkcpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyUHJvZmlsZVJlZnJlc2hlcigpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocC5pZGVudGl0eVN0YXR1cyA9PT0gcmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlZFUklGSUVEKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkxpY1ZlcmlmaWVkKClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LCAxMDAwKVxyXG4gICAgfSxcclxuXHJcbiAgICBjbGVhclByb2ZpbGVSZWZyZXNoZXIoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucHJvZmlsZVJlZnJlc2hlcikge1xyXG4gICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMucHJvZmlsZVJlZnJlc2hlcilcclxuICAgICAgICAgICAgdGhpcy5wcm9maWxlUmVmcmVzaGVyID0gMFxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgb25SZVN1Ym1pdCgpIHtcclxuICAgICAgICBQcm9maWxlU2VydmljZS5jbGVhclByb2ZpbGUoKS50aGVuKHAgPT4gdGhpcy5yZW5kZXJQcm9maWxlKHApKVxyXG4gICAgICAgIFByb2ZpbGVTZXJ2aWNlLmNsZWFyUHJvZmlsZVBob3RvKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBsaWNJbWdVUkw6ICcnLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLy8g5LiN6KaB5b+Y6K6w5riF5LiA5LiL57yT5a2YXHJcbiAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoJ2xpY1BpY1VybCcsICcnKVxyXG4gICAgfSxcclxuICAgIG9uTGljVmVyaWZpZWQoKSB7XHJcbiAgICAgICAgLy8gdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAvLyAgICAgc3RhdGU6ICdWRVJJRklFRCcsXHJcbiAgICAgICAgLy8gfSlcclxuICAgICAgICBpZiAodGhpcy5yZWRpcmVjdFVSTCkge1xyXG4gICAgICAgICAgICB3eC5yZWRpcmVjdFRvKHtcclxuICAgICAgICAgICAgICAgIHVybDogdGhpcy5yZWRpcmVjdFVSTCxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG59KSJdfQ==