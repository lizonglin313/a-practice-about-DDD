"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const profile_1 = require("../../service/profile");
const rental_pb_1 = require("../../service/proto_gen/rental/rental_pb");
const trip_1 = require("../../service/trip");
const format_1 = require("../../utils/format");
const routing_1 = require("../../utils/routing");
const tripStatusMap = new Map([
    [rental_pb_1.rental.v1.TripStatus.IN_PROGRESS, '进行中'],
    [rental_pb_1.rental.v1.TripStatus.FINISHED, '已完成'],
]);
const licStatusMap = new Map([
    [rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED, '未认证'],
    [rental_pb_1.rental.v1.IdentityStatus.PENDING, '未认证'],
    [rental_pb_1.rental.v1.IdentityStatus.VERIFIED, '已认证'],
]);
Page({
    scrollStates: {
        mainItems: [],
    },
    layoutReslover: undefined,
    data: {
        indicatorDots: true,
        vertical: false,
        autoplay: true,
        interval: 3000,
        duration: 500,
        circular: true,
        current: '0',
        promotionItems: [
            {
                img: 'https://img3.mukewang.com/620c5c810001d1f417920764.jpg',
                promotionID: '1',
            },
            {
                img: 'https://img2.mukewang.com/6216fef5000134df17920764.jpg',
                promotionID: '2',
            },
            {
                img: 'https://img4.mukewang.com/62184a9e00011dbd17920764.jpg',
                promotionID: '3',
            },
            {
                img: 'https://img3.mukewang.com/62187adc0001030417920764.jpg',
                promotionID: '4',
            },
            {
                img: 'https://img.mukewang.com/6218389d0001e43e17920764.jpg',
                promotionID: '5',
            },
        ],
        licStatus: licStatusMap.get(rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED),
        avatarURL: '',
        tripsHeight: 0,
        mainItems: [],
        navItems: [],
        navCount: 0,
        mainScroll: '',
        navSel: '',
        navScroll: '',
    },
    onLoad() {
        const layoutReady = new Promise((resolve) => {
            this.layoutReslover = resolve;
        });
        Promise.all([trip_1.TripService.getTrips(), layoutReady]).then(([trips]) => {
            this.populateTrips(trips.trips);
        });
        getApp().globalData.userInfo.then(userInfo => {
            this.setData({
                avatarURL: userInfo.avatarUrl,
            });
        });
    },
    onShow() {
        profile_1.ProfileService.getProfile().then(p => {
            this.setData({
                licStatus: licStatusMap.get(p.identityStatus || 0),
            });
        });
    },
    onReady() {
        wx.createSelectorQuery().select('#heading')
            .boundingClientRect(rect => {
            const height = wx.getSystemInfoSync().windowHeight - rect.height;
            this.setData({
                tripsHeight: height,
                navCount: Math.round(height / 50),
            }, () => {
                if (this.layoutReslover) {
                    this.layoutReslover(1);
                }
            });
        }).exec();
    },
    populateTrips(trips) {
        var _a, _b, _c, _d, _e, _f, _g, _h;
        const mainItems = [];
        const navItems = [];
        let navSel = '';
        let prevNav = '';
        for (let i = 0; i < trips.length; i++) {
            const trip = trips[i];
            const mainId = 'main-' + i;
            const navId = 'nav-' + i;
            const shortId = (_a = trip.id) === null || _a === void 0 ? void 0 : _a.substring(trip.id.length - 6);
            if (!prevNav) {
                prevNav = navId;
            }
            const tripData = {
                id: trip.id,
                shortId: '****' + shortId,
                start: ((_c = (_b = trip.trip) === null || _b === void 0 ? void 0 : _b.start) === null || _c === void 0 ? void 0 : _c.poiName) || '未知',
                end: '',
                distance: '',
                duration: '',
                fee: '',
                status: tripStatusMap.get((_d = trip.trip) === null || _d === void 0 ? void 0 : _d.status) || '未知',
            };
            const end = (_e = trip.trip) === null || _e === void 0 ? void 0 : _e.end;
            if (end) {
                tripData.end = end.poiName || '未知';
                tripData.distance = ((_f = end.kmDriven) === null || _f === void 0 ? void 0 : _f.toFixed(1)) + '公里';
                tripData.fee = format_1.formatFee(end.feeCent || 0);
                const dur = format_1.formatDuration((end.timestampSec || 0) - (((_h = (_g = trip.trip) === null || _g === void 0 ? void 0 : _g.start) === null || _h === void 0 ? void 0 : _h.timestampSec) || 0));
                tripData.duration = `${dur.hh}时${dur.mm}分`;
            }
            mainItems.push({
                id: mainId,
                navId: navId,
                navScrollId: prevNav,
                data: tripData,
            });
            navItems.push({
                id: navId,
                mainId: mainId,
                label: shortId || '',
            });
            if (i === 0) {
                navSel = navId;
            }
            prevNav = navId;
        }
        console.log('nav count:', this.data.navCount);
        for (let i = 0; i < this.data.navCount - 1; i++) {
            navItems.push({
                id: '',
                mainId: '',
                label: '',
            });
        }
        this.setData({
            mainItems: mainItems,
            navItems: navItems,
            navSel: navSel,
        }, () => {
            this.prepareScrollStates();
        });
    },
    prepareScrollStates() {
        wx.createSelectorQuery().selectAll('.main-item')
            .fields({
            id: true,
            dataset: true,
            rect: true
        }).exec(res => {
            this.scrollStates.mainItems = res[0];
        });
    },
    onSwiperChange(e) {
    },
    onPromotionItemTap(e) {
    },
    onRegisterTap() {
        wx.navigateTo({
            url: routing_1.routing.register(),
        });
    },
    onGetUserInfo(e) {
        const userInfo = e.detail.userInfo;
        if (userInfo) {
            getApp().resolveUserInfo(userInfo);
            this.setData({
                avatarURL: userInfo.avatarUrl,
            });
        }
    },
    onNavItemTap(e) {
        var _a, _b, _c;
        const mainId = (_b = (_a = e.currentTarget) === null || _a === void 0 ? void 0 : _a.dataset) === null || _b === void 0 ? void 0 : _b.mainId;
        const navId = (_c = e.currentTarget) === null || _c === void 0 ? void 0 : _c.id;
        if (mainId) {
            this.setData({
                mainScroll: mainId,
                navSel: navId,
            });
        }
    },
    onMainScroll(e) {
        var _a, _b;
        const top = ((_a = e.currentTarget) === null || _a === void 0 ? void 0 : _a.offsetTop) + ((_b = e.detail) === null || _b === void 0 ? void 0 : _b.scrollTop);
        if (top === undefined) {
            return;
        }
        const selItem = this.scrollStates.mainItems.find(v => v.top >= top);
        if (!selItem) {
            return;
        }
        this.setData({
            navSel: selItem.dataset.navId,
            navScroll: selItem.dataset.navScrollId,
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXl0cmlwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm15dHJpcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxtREFBc0Q7QUFDdEQsd0VBQWlFO0FBQ2pFLDZDQUFnRDtBQUNoRCwrQ0FBOEQ7QUFDOUQsaURBQTZDO0FBcUM3QyxNQUFNLGFBQWEsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUMxQixDQUFDLGtCQUFNLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDO0lBQ3pDLENBQUMsa0JBQU0sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUM7Q0FFekMsQ0FBQyxDQUFBO0FBR0YsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDekIsQ0FBQyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQztJQUM3QyxDQUFDLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDO0lBQ3pDLENBQUMsa0JBQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUM7Q0FDN0MsQ0FBQyxDQUFBO0FBRUYsSUFBSSxDQUFDO0lBQ0QsWUFBWSxFQUFFO1FBQ1YsU0FBUyxFQUFFLEVBQTRCO0tBQzFDO0lBRUQsY0FBYyxFQUFFLFNBQW1EO0lBRW5FLElBQUksRUFBRTtRQUNGLGFBQWEsRUFBRSxJQUFJO1FBQ25CLFFBQVEsRUFBRSxLQUFLO1FBQ2YsUUFBUSxFQUFFLElBQUk7UUFDZCxRQUFRLEVBQUUsSUFBSTtRQUNkLFFBQVEsRUFBRSxHQUFHO1FBQ2IsUUFBUSxFQUFFLElBQUk7UUFDZCxPQUFPLEVBQUUsR0FBRztRQUNaLGNBQWMsRUFBRTtZQUNaO2dCQUNJLEdBQUcsRUFBRSx3REFBd0Q7Z0JBQzdELFdBQVcsRUFBRSxHQUFHO2FBQ25CO1lBQ0Q7Z0JBQ0ksR0FBRyxF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RSxFQUFFLENBQUE7UUFDekMsSUFBSSxNQUFNLEVBQUU7WUFDUixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNULFVBQVUsRUFBRSxNQUFNO2dCQUNsQixNQUFNLEVBQUUsS0FBSzthQUNoQixDQUFDLENBQUE7U0FDTDtJQUNMLENBQUM7SUFDRCxZQUFZLENBQUMsQ0FBTTs7UUFDZixNQUFNLEdBQUcsR0FBVyxPQUFBLENBQUMsQ0FBQyxhQUFhLDBDQUFFLFNBQVMsV0FBRyxDQUFDLENBQUMsTUFBTSwwQ0FBRSxTQUFTLENBQUEsQ0FBQTtRQUNwRSxJQUFJLEdBQUcsS0FBSyxTQUFTLEVBQUU7WUFDbkIsT0FBTTtTQUNUO1FBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQTtRQUNuRSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1YsT0FBTTtTQUNUO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNULE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUs7WUFDN0IsU0FBUyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVztTQUN6QyxDQUFDLENBQUE7SUFDTixDQUFDO0NBQ0osQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUFwcE9wdGlvbiB9IGZyb20gXCIuLi8uLi9hcHBvcHRpb25cIlxyXG5pbXBvcnQgeyBQcm9maWxlU2VydmljZSB9IGZyb20gXCIuLi8uLi9zZXJ2aWNlL3Byb2ZpbGVcIlxyXG5pbXBvcnQgeyByZW50YWwgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9wcm90b19nZW4vcmVudGFsL3JlbnRhbF9wYlwiXHJcbmltcG9ydCB7IFRyaXBTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL3NlcnZpY2UvdHJpcFwiXHJcbmltcG9ydCB7IGZvcm1hdER1cmF0aW9uLCBmb3JtYXRGZWUgfSBmcm9tIFwiLi4vLi4vdXRpbHMvZm9ybWF0XCJcclxuaW1wb3J0IHsgcm91dGluZyB9IGZyb20gXCIuLi8uLi91dGlscy9yb3V0aW5nXCJcclxuaW1wb3J0IHsgZ2V0VXNlckluZm8gfSBmcm9tIFwiLi4vLi4vdXRpbHMvd3hhcGlcIlxyXG5cclxuaW50ZXJmYWNlIFRyaXAge1xyXG4gICAgaWQ6IHN0cmluZ1xyXG4gICAgc2hvcnRJZDogc3RyaW5nXHJcbiAgICBzdGFydDogc3RyaW5nXHJcbiAgICBlbmQ6IHN0cmluZ1xyXG4gICAgZHVyYXRpb246IHN0cmluZ1xyXG4gICAgZmVlOiBzdHJpbmdcclxuICAgIGRpc3RhbmNlOiBzdHJpbmdcclxuICAgIHN0YXR1czogc3RyaW5nXHJcbn1cclxuXHJcbmludGVyZmFjZSBNYWluSXRlbSB7XHJcbiAgICBpZDogc3RyaW5nXHJcbiAgICBuYXZJZDogc3RyaW5nXHJcbiAgICBuYXZTY3JvbGxJZDogc3RyaW5nXHJcbiAgICBkYXRhOiBUcmlwXHJcbn1cclxuXHJcbmludGVyZmFjZSBOYXZJdGVtIHtcclxuICAgIGlkOiBzdHJpbmdcclxuICAgIG1haW5JZDogc3RyaW5nXHJcbiAgICBsYWJlbDogc3RyaW5nXHJcbn1cclxuXHJcbmludGVyZmFjZSBNYWluSXRlbVF1ZXJ5UmVxdWVzdCB7XHJcbiAgICBpZDogc3RyaW5nXHJcbiAgICB0b3A6IG51bWJlclxyXG4gICAgZGF0YXNldDoge1xyXG4gICAgICAgIG5hdklkOiBzdHJpbmdcclxuICAgICAgICBuYXZTY3JvbGxJZDogc3RyaW5nXHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5jb25zdCB0cmlwU3RhdHVzTWFwID0gbmV3IE1hcChbXHJcbiAgICBbcmVudGFsLnYxLlRyaXBTdGF0dXMuSU5fUFJPR1JFU1MsICfov5vooYzkuK0nXSxcclxuICAgIFtyZW50YWwudjEuVHJpcFN0YXR1cy5GSU5JU0hFRCwgJ+W3suWujOaIkCddLFxyXG4gICAgLy9bcmVudGFsLnYxLlRyaXBTdGF0dXMuVFNfTk9UX1NQRUNJRklFRCwgJ+acquefpSddLFxyXG5dKVxyXG5cclxuXHJcbmNvbnN0IGxpY1N0YXR1c01hcCA9IG5ldyBNYXAoW1xyXG4gICAgW3JlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5VTlNVQk1JVFRFRCwgJ+acquiupOivgSddLFxyXG4gICAgW3JlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5QRU5ESU5HLCAn5pyq6K6k6K+BJ10sXHJcbiAgICBbcmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlZFUklGSUVELCAn5bey6K6k6K+BJ10sXHJcbl0pXHJcblxyXG5QYWdlKHtcclxuICAgIHNjcm9sbFN0YXRlczoge1xyXG4gICAgICAgIG1haW5JdGVtczogW10gYXMgTWFpbkl0ZW1RdWVyeVJlcXVlc3RbXSxcclxuICAgIH0sXHJcblxyXG4gICAgbGF5b3V0UmVzbG92ZXI6IHVuZGVmaW5lZCBhcyAoKHZhbHVlOiB1bmtub3duKSA9PiB2b2lkKSB8IHVuZGVmaW5lZCxcclxuXHJcbiAgICBkYXRhOiB7XHJcbiAgICAgICAgaW5kaWNhdG9yRG90czogdHJ1ZSxcclxuICAgICAgICB2ZXJ0aWNhbDogZmFsc2UsXHJcbiAgICAgICAgYXV0b3BsYXk6IHRydWUsXHJcbiAgICAgICAgaW50ZXJ2YWw6IDMwMDAsXHJcbiAgICAgICAgZHVyYXRpb246IDUwMCxcclxuICAgICAgICBjaXJjdWxhcjogdHJ1ZSxcclxuICAgICAgICBjdXJyZW50OiAnMCcsXHJcbiAgICAgICAgcHJvbW90aW9uSXRlbXM6IFtcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgaW1nOiAnaHR0cHM6Ly9pbWczLm11a2V3YW5nLmNvbS82MjBjNWM4MTAwMDFkMWY0MTc5MjA3NjQuanBnJyxcclxuICAgICAgICAgICAgICAgIHByb21vdGlvbklEOiAnMScsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGltZzogJ2h0dHBzOi8vaW1nMi5tdWtld2FuZy5jb20vNjIxNmZlZjUwMDAxMzRkZjE3OTIwNzY0LmpwZycsXHJcbiAgICAgICAgICAgICAgICBwcm9tb3Rpb25JRDogJzInLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBpbWc6ICdodHRwczovL2ltZzQubXVrZXdhbmcuY29tLzYyMTg0YTllMDAwMTFkYmQxNzkyMDc2NC5qcGcnLFxyXG4gICAgICAgICAgICAgICAgcHJvbW90aW9uSUQ6ICczJyxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgaW1nOiAnaHR0cHM6Ly9pbWczLm11a2V3YW5nLmNvbS82MjE4N2FkYzAwMDEwMzA0MTc5MjA3NjQuanBnJyxcclxuICAgICAgICAgICAgICAgIHByb21vdGlvbklEOiAnNCcsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGltZzogJ2h0dHBzOi8vaW1nLm11a2V3YW5nLmNvbS82MjE4Mzg5ZDAwMDFlNDNlMTc5MjA3NjQuanBnJyxcclxuICAgICAgICAgICAgICAgIHByb21vdGlvbklEOiAnNScsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgXSxcclxuICAgICAgICBsaWNTdGF0dXM6IGxpY1N0YXR1c01hcC5nZXQocmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlVOU1VCTUlUVEVEKSxcclxuICAgICAgICBhdmF0YXJVUkw6ICcnLFxyXG4gICAgICAgIHRyaXBzSGVpZ2h0OiAwLFxyXG4gICAgICAgIG1haW5JdGVtczogW10gYXMgTWFpbkl0ZW1bXSxcclxuICAgICAgICBuYXZJdGVtczogW10gYXMgTmF2SXRlbVtdLFxyXG4gICAgICAgIG5hdkNvdW50OiAwLFxyXG4gICAgICAgIG1haW5TY3JvbGw6ICcnLFxyXG4gICAgICAgIG5hdlNlbDogJycsXHJcbiAgICAgICAgbmF2U2Nyb2xsOiAnJyxcclxuICAgIH0sXHJcbiAgICBvbkxvYWQoKSB7XHJcbiAgICAgICAgY29uc3QgbGF5b3V0UmVhZHkgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmxheW91dFJlc2xvdmVyID0gcmVzb2x2ZVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIFByb21pc2UuYWxsKFtUcmlwU2VydmljZS5nZXRUcmlwcygpLCBsYXlvdXRSZWFkeV0pLnRoZW4oKFt0cmlwc10pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5wb3B1bGF0ZVRyaXBzKHRyaXBzLnRyaXBzISlcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBnZXRBcHA8SUFwcE9wdGlvbj4oKS5nbG9iYWxEYXRhLnVzZXJJbmZvLnRoZW4odXNlckluZm8gPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgYXZhdGFyVVJMOiB1c2VySW5mby5hdmF0YXJVcmwsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgXHJcbiAgICB9LFxyXG5cclxuICAgIG9uU2hvdygpIHtcclxuICAgICAgICBQcm9maWxlU2VydmljZS5nZXRQcm9maWxlKCkudGhlbihwPT57XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBsaWNTdGF0dXM6IGxpY1N0YXR1c01hcC5nZXQocC5pZGVudGl0eVN0YXR1cyB8fCAwKSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG5cclxuICAgIH0sXHJcblxyXG4gICAgb25SZWFkeSgpIHtcclxuXHJcbiAgICAgICAgd3guY3JlYXRlU2VsZWN0b3JRdWVyeSgpLnNlbGVjdCgnI2hlYWRpbmcnKVxyXG4gICAgICAgICAgICAuYm91bmRpbmdDbGllbnRSZWN0KHJlY3QgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd3guZ2V0U3lzdGVtSW5mb1N5bmMoKS53aW5kb3dIZWlnaHQgLSByZWN0LmhlaWdodFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICB0cmlwc0hlaWdodDogaGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgICAgIG5hdkNvdW50OiBNYXRoLnJvdW5kKGhlaWdodCAvIDUwKSxcclxuICAgICAgICAgICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXlvdXRSZXNsb3Zlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxheW91dFJlc2xvdmVyKDEpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSkuZXhlYygpXHJcbiAgICB9LFxyXG4gICAgcG9wdWxhdGVUcmlwcyh0cmlwczogcmVudGFsLnYxLklUcmlwRW50aXR5W10pIHtcclxuICAgICAgICBjb25zdCBtYWluSXRlbXM6IE1haW5JdGVtW10gPSBbXVxyXG4gICAgICAgIGNvbnN0IG5hdkl0ZW1zOiBOYXZJdGVtW10gPSBbXVxyXG4gICAgICAgIGxldCBuYXZTZWwgPSAnJ1xyXG4gICAgICAgIGxldCBwcmV2TmF2ID0gJydcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyaXBzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRyaXAgPSB0cmlwc1tpXVxyXG4gICAgICAgICAgICBjb25zdCBtYWluSWQgPSAnbWFpbi0nICsgaVxyXG4gICAgICAgICAgICBjb25zdCBuYXZJZCA9ICduYXYtJyArIGlcclxuICAgICAgICAgICAgY29uc3Qgc2hvcnRJZCA9IHRyaXAuaWQ/LnN1YnN0cmluZyh0cmlwLmlkLmxlbmd0aCAtIDYpXHJcbiAgICAgICAgICAgIGlmICghcHJldk5hdikge1xyXG4gICAgICAgICAgICAgICAgcHJldk5hdiA9IG5hdklkXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gZW5kOiAn5a6/6IiNJyxcclxuICAgICAgICAgICAgLy8gZGlzdGFuY2U6ICcyLjTlhazph4wnLFxyXG4gICAgICAgICAgICAvLyBkdXJhdGlvbjogJzDml7YxMuWIhumSnycsXHJcbiAgICAgICAgICAgIC8vIGZlZTogJzUuMuWFgycsXHJcbiAgICAgICAgICAgIGNvbnN0IHRyaXBEYXRhOiBUcmlwID0ge1xyXG4gICAgICAgICAgICAgICAgaWQ6IHRyaXAuaWQhLFxyXG4gICAgICAgICAgICAgICAgc2hvcnRJZDogJyoqKionICsgc2hvcnRJZCxcclxuICAgICAgICAgICAgICAgIHN0YXJ0OiB0cmlwLnRyaXA/LnN0YXJ0Py5wb2lOYW1lIHx8ICfmnKrnn6UnLFxyXG4gICAgICAgICAgICAgICAgZW5kOiAnJyxcclxuICAgICAgICAgICAgICAgIGRpc3RhbmNlOiAnJyxcclxuICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAnJyxcclxuICAgICAgICAgICAgICAgIGZlZTogJycsXHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IHRyaXBTdGF0dXNNYXAuZ2V0KHRyaXAudHJpcD8uc3RhdHVzISkgfHwgJ+acquefpScsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgZW5kID0gdHJpcC50cmlwPy5lbmRcclxuICAgICAgICAgICAgaWYgKGVuZCkge1xyXG4gICAgICAgICAgICAgICAgdHJpcERhdGEuZW5kID0gZW5kLnBvaU5hbWUgfHwgJ+acquefpSdcclxuICAgICAgICAgICAgICAgIHRyaXBEYXRhLmRpc3RhbmNlID0gZW5kLmttRHJpdmVuPy50b0ZpeGVkKDEpICsgJ+WFrOmHjCdcclxuICAgICAgICAgICAgICAgIHRyaXBEYXRhLmZlZSA9IGZvcm1hdEZlZShlbmQuZmVlQ2VudCB8fCAwKVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZHVyID0gZm9ybWF0RHVyYXRpb24oKGVuZC50aW1lc3RhbXBTZWMgfHwgMCkgLSAodHJpcC50cmlwPy5zdGFydD8udGltZXN0YW1wU2VjIHx8IDApKVxyXG4gICAgICAgICAgICAgICAgdHJpcERhdGEuZHVyYXRpb24gPSBgJHtkdXIuaGh95pe2JHtkdXIubW195YiGYFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHRyaXBzKVxyXG4gICAgICAgICAgICBtYWluSXRlbXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpZDogbWFpbklkLFxyXG4gICAgICAgICAgICAgICAgbmF2SWQ6IG5hdklkLFxyXG4gICAgICAgICAgICAgICAgbmF2U2Nyb2xsSWQ6IHByZXZOYXYsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiB0cmlwRGF0YSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgbmF2SXRlbXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpZDogbmF2SWQsXHJcbiAgICAgICAgICAgICAgICBtYWluSWQ6IG1haW5JZCxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiBzaG9ydElkIHx8ICcnLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICBpZiAoaSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgbmF2U2VsID0gbmF2SWRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwcmV2TmF2ID0gbmF2SWRcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKCduYXYgY291bnQ6JywgdGhpcy5kYXRhLm5hdkNvdW50KVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5kYXRhLm5hdkNvdW50IC0gMTsgaSsrKSB7XHJcbiAgICAgICAgICAgIG5hdkl0ZW1zLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgaWQ6ICcnLFxyXG4gICAgICAgICAgICAgICAgbWFpbklkOiAnJyxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiAnJyxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIG1haW5JdGVtczogbWFpbkl0ZW1zLFxyXG4gICAgICAgICAgICBuYXZJdGVtczogbmF2SXRlbXMsXHJcbiAgICAgICAgICAgIG5hdlNlbDogbmF2U2VsLFxyXG4gICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5wcmVwYXJlU2Nyb2xsU3RhdGVzKClcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBwcmVwYXJlU2Nyb2xsU3RhdGVzKCkge1xyXG4gICAgICAgIHd4LmNyZWF0ZVNlbGVjdG9yUXVlcnkoKS5zZWxlY3RBbGwoJy5tYWluLWl0ZW0nKVxyXG4gICAgICAgICAgICAuZmllbGRzKHtcclxuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgZGF0YXNldDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHJlY3Q6IHRydWVcclxuICAgICAgICAgICAgfSkuZXhlYyhyZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxTdGF0ZXMubWFpbkl0ZW1zID0gcmVzWzBdXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uU3dpcGVyQ2hhbmdlKGU6IGFueSkge1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coZSlcclxuICAgIH0sXHJcblxyXG4gICAgb25Qcm9tb3Rpb25JdGVtVGFwKGU6IGFueSkge1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coZSlcclxuICAgIH0sXHJcblxyXG4gICAgb25SZWdpc3RlclRhcCgpIHtcclxuICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcclxuICAgICAgICAgICAgLy8gdXJsOiAnL3BhZ2VzL3JlZ2lzdGVyL3JlZ2lzdGVyJyxcclxuICAgICAgICAgICAgdXJsOiByb3V0aW5nLnJlZ2lzdGVyKCksXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcbiAgICBvbkdldFVzZXJJbmZvKGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHVzZXJJbmZvOiBXZWNoYXRNaW5pcHJvZ3JhbS5Vc2VySW5mbyA9IGUuZGV0YWlsLnVzZXJJbmZvXHJcbiAgICAgICAgaWYgKHVzZXJJbmZvKSB7XHJcbiAgICAgICAgICAgIGdldEFwcDxJQXBwT3B0aW9uPigpLnJlc29sdmVVc2VySW5mbyh1c2VySW5mbylcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIGF2YXRhclVSTDogdXNlckluZm8uYXZhdGFyVXJsLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9LFxyXG4gICAgb25OYXZJdGVtVGFwKGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG1haW5JZDogc3RyaW5nID0gZS5jdXJyZW50VGFyZ2V0Py5kYXRhc2V0Py5tYWluSWRcclxuICAgICAgICBjb25zdCBuYXZJZDogc3RyaW5nID0gZS5jdXJyZW50VGFyZ2V0Py5pZFxyXG4gICAgICAgIGlmIChtYWluSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIG1haW5TY3JvbGw6IG1haW5JZCxcclxuICAgICAgICAgICAgICAgIG5hdlNlbDogbmF2SWQsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIG9uTWFpblNjcm9sbChlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCB0b3A6IG51bWJlciA9IGUuY3VycmVudFRhcmdldD8ub2Zmc2V0VG9wICsgZS5kZXRhaWw/LnNjcm9sbFRvcFxyXG4gICAgICAgIGlmICh0b3AgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc2VsSXRlbSA9IHRoaXMuc2Nyb2xsU3RhdGVzLm1haW5JdGVtcy5maW5kKHYgPT4gdi50b3AgPj0gdG9wKVxyXG4gICAgICAgIGlmICghc2VsSXRlbSkge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgbmF2U2VsOiBzZWxJdGVtLmRhdGFzZXQubmF2SWQsXHJcbiAgICAgICAgICAgIG5hdlNjcm9sbDogc2VsSXRlbS5kYXRhc2V0Lm5hdlNjcm9sbElkLFxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn0pIl19